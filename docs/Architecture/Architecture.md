# RAGMaker Architecture

## 1. 概要
本文書は、RAG (Retrieval-Augmented Generation) およびAIエージェントを用いた対話型アプリケーション「RAGMaker」のアーキテクチャを定義します。
このシステムは、ユーザーが指定した場所に**ナレッジベース**を作成し、その中で情報を管理・活用する仕組みを提供します。

主要な機能は以下の2つのプロンプト（コマンド）によって実現されます。
1.  **情報の収集とカタログ化**: ローカル・Web・GitHubなど様々なソースから情報を自動収集し、各ドキュメントの要約を含むカタログ（`discovery.json`）をナレッジベース内に作成します。この処理では、AIエージェントがオーケストレーターとして複数のツールを駆使し、複雑なタスクを遂行します。
2.  **対話による情報検索**: ナレッジベース内で対話インターフェイスを介して質問を受け付け、カタログを利用して関連情報を検索し、適切な回答を生成します。

## 2. 操作コマンド
ユーザーはAIエージェントであるGemini CLIを介して、主に以下のコマンドでシステムを操作します。

*   `/rag <ソースパス>`: **情報収集・カタログ化機能。** このコマンドを実行すると、AIエージェントが対話を開始します。エージェントはまず、既存のナレッジベースを使用するか、新しいナレッジベースを作成するかをユーザーに尋ねます。新しいナレッジベースを作成する場合、エージェントは `create_knowledge_base` ツールを内部的に使用して初期設定を行います。その後、指定されたソースから情報を収集・解析し、対象ナレッジベースのカタログ(`discovery.json`)に情報を登録します。この一連のフローは `.gemini/commands/rag.toml` で定義されます。
*   `/ask <質問文>`: **対話機能。** **ナレッジベースのルートディレクトリで実行する必要があります。** カレントディレクトリにあるカタログ(`discovery.json`)を読み込み、質問に最も関連性の高いドキュメントを特定し、その内容を基に回答を生成します。このコマンドは `.gemini/commands/ask.toml` で定義されます。

## 3. アーキテクチャ詳細

### 3.1. 役割の異なる2つの `discovery.json`

RAGMakerアーキテクチャを理解する上で、役割の異なる2つの `discovery.json` ファイルの存在を認識することが重要です。

1.  **プロジェクトルートの `discovery.json` (`rag-maker/discovery.json`)**
    *   **役割**: **ツールのカタログ**。`rag-maker`プロジェクトが提供する全ツール（`create_knowledge_base`, `http_fetch`, `github_fetch` など）の定義が格納されています。
    *   **使用場面**: 主に `/rag` コマンドの実行初期段階で使われます。AIエージェントは、まずこのファイルを読み込んで利用可能なツール群を認識し、ナレッジベースを新規作成する (`create_knowledge_base`) といったタスクを実行します。

2.  **ナレッジベースルートの `discovery.json` (`<KB_ROOT>/discovery.json`)**
    *   **役割**: **ドキュメントのカタログ**。そのナレッジベースに取り込まれたドキュメントの情報（タイトル、要約、キャッシュパスなど）が一元管理されます。
    *   **使用場面**:
        *   `/ask` コマンド実行時に、AIエージェントがユーザーの質問に回答するための情報源として直接参照します。
        *   `/rag` コマンド実行時に、`entry_discovery` ツールによって新しいドキュメント情報が追記されます。
    *   **補足**: このファイルは、ナレッジベース作成時にプロジェクトルートの `discovery.json` を雛形としてコピーされるため、ツール定義も含まれています。これにより、ナレッジベース自体が自己完結した環境となります。

### 3.2. 情報収集・カタログ化: `/rag` コマンドフロー
このコマンドは、AIエージェントの読解・要約能力と支援ツールを組み合わせ、指定されたソースから情報を収集してナレッジベースのカタログを構築します。

1.  コマンド実行後、AIエージェントはまず**プロジェクトルートの `discovery.json`** を参照して利用可能なツールを把握します。
2.  次に、ユーザーとの対話を通じて、既存のナレッジベースを使用するか、新規作成するかを決定します。
    *   **新規作成の場合:** エージェントは `create_knowledge_base` ツールを実行し、ユーザーが指定した場所にナレッジベースの基本構造（`.gemini` ディレクトリ、`cache` ディレクトリ、初期 `discovery.json`）をセットアップします。
    *   **既存使用の場合:** エージェントは `ask_dir` ツールなどを使い、ユーザーに対象となるナレッジベースのディレクトリを選択させます。
3.  ユーザーが指定したナレッジベースの場所（`<KB_ROOT>`）を基準に、後続の処理（ドキュメントのダウンロード、キャッシュへの保存など）が行われます。
4.  ソースの種類に応じて、以下の処理を実行します。
    *   **ローカルディレクトリ:** ディレクトリ内の全ドキュメントを読み込みます。
    *   **Webページ:** 指定URLから再帰的にHTMLを走査・収集し、コンテンツを抽出してマークダウンに整形します。
    *   **GitHubリポジトリ:** リポジトリ内のドキュメントファイルを収集し、マークダウンに整形します。
5.  AIエージェントは収集したマークダウン文書群を走査し、各ドキュメントのタイトルと要約を生成します。
6.  最後に、`entry_discovery` ツールを使い、生成したタイトル、要約、ファイルパスなどの情報を、対象**ナレッジベースの `discovery.json`** に追記します。

詳細なインストラクションは、ナレッジベース内の`.gemini/commands/rag.toml`に定義されています。

### 3.3. 対話: `/ask` コマンドフロー
このコマンドは、AIエージェントの推論能力を活用し、ユーザーの質問に対してナレッジベース内の情報から最適な回答を生成します。

1.  ユーザーは、**回答の基としたいナレッジベースのルートディレクトリに移動**し、`gemini /ask "<質問文>"` を実行します。
2.  AIエージェントは、カレントディレクトリにある**ナレッジベースの `discovery.json`** を読み込み、カタログ化されたドキュメントのリスト（タイトル、要約など）を取得します。
3.  ユーザーの質問と各ドキュメントの情報を照らし合わせ、最も関連性が高いと判断したドキュメントを選択します。
4.  選択したドキュメントの内容を読み込み、それを基に最終的な回答を生成してユーザーに提示します。

具体的なインストラクションは、ナレッジベース内の`.gemini/commands/ask.toml`に定義されています。

## 4. ツール一覧
AIエージェントが利用可能なツール（`create_knowledge_base` などを含む）の一覧は、各ナレッジベースのルートにある`discovery.json`に定義されています。
`/rag` コマンドの初期実行時には、**プロジェクトルートの `discovery.json`** が参照されます。
