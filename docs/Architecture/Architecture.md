# RAGMaker Architecture

## 1. 概要
本文書は、RAG (Retrieval-Augmented Generation) およびAIエージェントを用いた対話型アプリケーション「RAGMaker」のアーキテクチャを定義する。
このシステムは、「**ローカル・Web・GitHubいずれかのソースから情報を自動収集し、各ドキュメントの要約を記載したカタログを作成するためのプロンプト**」および「**対話インターフェイスで質問文を得て、カタログを利用しながら適切な回答を提供するためのプロンプト**」の２つのプロンプトによって成り立つ。特に前者においてはAIエージェントはオーケストレーターとなり、ツールを利用しながら複雑な操作を進める。

## 2. 操作コマンド
ユーザーはAIエージェントであるGemini CLIを介して、以下の2つの主要コマンドでシステムを操作する。

*   `/rag <ソースパス>`: **中核機能。** AIエージェントは自らの推論能力を用いてソースの各ドキュメントの概要を記述をカタログに記述し、それらのドキュメントのルートに配置する。また<ソースパス>をRAGMakerルートのカタログに登録する。`.gemini/commands/rag.toml`で定義される。
*   `/ask <質問文>`: **対話機能。** RAGMakerルートのカタログを読み、質問に最も関連性の高いソースディレクトリを選択する。さらにその中のカタログを読み、最も関連性の高いマークダウンファイルを選択し、そのドキュメントの内容を基に回答を生成する。`.gemini/commands/ask.toml`で定義される。

## 3. アーキテクチャ詳細

### 3.1. 各種カタログを定義する`discovery.json`

RAGMakerのアーキテクチャの中核を担うのが**カタログ**である。大きく分けて二種類存在する。

1. RAGMakerルートの`discovery.json`: AIエージェントがツールや文書ディレクトリのパスを解決する際に用いる
2. 文書ルートの`discovery.json`: AIエージェントが文書ディレクトリ内の各マークダウンファイルのパスを解決する際に用いる

### 3.2. 中核機能: `/rag` コマンドフロー
このコマンドは、AIエージェント自身の読解・要約能力と、いくつかの支援ツールを組み合わせることで、指定されたソースからドキュメントのカタログを構築する。

*   **ソースがローカルディレクトリの場合:** ディレクトリ内の全ドキュメントを読み込む。
*   **Webページの場合:** 指定URLより再帰的にHTML文書を走査し、コンテンツのみのHTML文書に整形して収集、マークダウンに整形する
*   **GitHubリポジトリの場合:** `github_fetch` ツールを使い、リポジトリ内のドキュメントファイルを収集し、マークダウンに整形する。

AIエージェントはマークダウン文書群をすべて走査し、タイトルと要約を生成、文書ディレクトリにカタログとして配置する。

具体的なインストラクションは、@.gemini/commands/rag.toml に定義される。


### 3.3. 対話機能: `/ask` コマンドフロー
このコマンドは、AIエージェントの推論能力を活用し、ユーザーの質問に対して最適な回答を生成する。

`/ask`コマンドが実行されると、システムはプロジェクトルートの`discovery.json`カタログとユーザーの質問を基に、AIエージェントに対して回答生成を指示する。AIエージェントはカタログ情報を参照して最も関連性の高いドキュメントを特定し、その内容を読み解いた上で、最終的な回答を生成する。この一連の判断と実行は、AIエージェントが自律的に行う。

具体的なインストラクションは、@.gemini/commands/ask.toml に定義される。

## 4. ツール一覧

- `read_many_files`: ファイルを読むためのGemini CLIネイティブ実装ツール
- `web_fetch`: 指定されたURLを起点としたWebの文書群を収集する
- `github_fetch`: 指定されたリポジトリ内の`docs/`ディレクトリを保存する
- `html_to_markdown`: 指定されたディレクトリ内のHTML文書をRAGのソースとして最適化されたマークダウンに変換する

## 5. 使用技術

*   **言語: Python**
*   **HTTPクライアント: `requests`, `BeautifulSoup`**
    *   **理由:** Webページからの情報収集（クローリング）を安定して行うための、実績のある標準的な組み合わせであるため。
*   **Gitクライアント: `GitPython`**
    *   **理由:** GitHubからdocsのような特定のフォルダのみをクローンするため。
*   **UI: Gemini CLI**
    *   **理由:** ユーザーとの対話インターフェースを提供し、GUI不要、自然言語を理解して各種ツールを実行できるため。