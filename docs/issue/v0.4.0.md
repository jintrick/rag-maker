# Issue v0.4.0

## 前提知識
*   `docs/Architecture/Architecture.md`
*   `.gemini/commands/rag.md`
*   `.gemini/commands/ask.md`

## 経緯
これまで`/rag`コマンドで作成されたナレッジベースは、`rag-maker`プロジェクトの`cache/`ディレクトリ内に保存されていました。この構造では、ナレッジベースに対して質問（`/ask`）をする際に、常に`rag-maker`プロジェクトのルートディレクトリでCLIを起動する必要があり、ユーザーにとって利便性が低いという問題がありました。

## 現状の問題点
- プロジェクトの内部にナレッジベースが存在してしまっていて、`/ask`コマンドの実行は、このプロジェクトルートでGemini CLIを起動しなければ使えない。


## 解決策の概要
ナレッジベースを`rag-maker`プロジェクトから完全に独立させ、ユーザーが指定した任意の場所に作成できるようにします。各ナレッジベースは、それ自体が自己完結した実行環境となり、そのディレクトリ内で直接`/ask`コマンドを実行できるようになります。

## 解決策の詳細
この実現のために、以下の2つの主要な変更を導入します。

1.  **新しいツール `create_knowledge_base` の作成 (`tools/create_knowledge_base.py`)**
    *   **機能**: 指定されたパスに、ナレッジベースの基本的なディレクトリ構造と設定ファイルをセットアップする新しいツールを作成します。
    *   **引数**: `--kb-root` (ナレッジベースを作成するルートパス) を受け取ります。
    *   **処理内容**:
        1.  `--kb-root` で指定されたディレクトリを作成します。
        2.  `rag-maker`プロジェクトのルートにある `.gemini` ディレクトリを、新しいナレッジベースのルート (`--kb-root`) にコピーします。これにより、`/ask`コマンドなどが利用可能になります。
        3.  ナレッジベースのルートに、空の `documents` 配列を持つ `discovery.json` を初期作成します。
        4.  ナレッジベース内に、ドキュメントファイルを保存するための `cache` ディレクトリを作成します。

2.  **`/rag` コマンドのワークフロー変更 (`.gemini/commands/rag.md`)**
    *   **機能**: `/rag` コマンドの実行時に、まず対象となるナレッジベースの場所をユーザーに確認するようにワークフローを変更します。
    *   **処理フローの変更点**:
        1.  ワークフローの開始時に `ask_dir` ツールを実行し、ユーザーにナレッジベースのルートディレクトリ（以降 `<KB_ROOT>`）を選択させます。
        2.  以降のツール（`make_cache_dir`, `http_fetch`, `entry_discovery`など）のパス解決は、すべて `<KB_ROOT>` を基準に行うように指示を変更します。
        3.  例えば、キャッシュディレクトリは `<KB_ROOT>/cache/` となり、取得したドキュメントファイルはすべてこのディレクトリ直下に保存されます。`entry_discovery` は `<KB_ROOT>/discovery.json` を更新します。

## 参考とすべきスクリプト等
*   `tools/ask_dir.py` (ユーザーにディレクトリを選択させるために利用)
*   `tools/file_sync.py` (`.gemini` ディレクトリのコピーロジックの参考に)

## テスト方法
Julesへ。
このIssueの実装は、複数のツールとワークフローにまたがる大きな変更です。
`gemini` CLIの直接実行はテスト環境では行えないため、以下の通り、各コンポーネントの単体テストを実装・更新してください。

### 1. `create_knowledge_base.py` の単体テスト
- **テストファイル**: `test/test_create_knowledge_base.py` (新規作成)
- **目的**: ツールが指定されたパスにナレッジベースの骨格を正しく生成できることを確認します。
- **テスト手順**:
    1. `unittest.TestCase` を使用し、一時的なテストディレクトリを作成します。
    2. `create_knowledge_base.py` を `--kb-root` に一時ディレクトリを指定して実行します。
    3. 以下の点が満たされていることをアサートで検証します。
        - 指定したパスに `.gemini` ディレクトリがコピーされていること。
        - 指定したパスに `cache` ディレクトリが作成されていること。
        - 指定したパスに `discovery.json` が作成されていること。
        - `discovery.json` の内容が、空の `documents` 配列を持つ正しい初期JSON構造であること。

### 2. `make_cache_dir.py` の単体テスト
- **テストファイル**: `test/test_make_cache_dir.py` (新規作成または更新)
- **目的**: ツールが `--kb-root` 引数に基づいて正しく `cache` ディレクトリを作成できることを確認します。
- **テスト手順**:
    1. `unittest.TestCase` を使用し、一時的なテストディレクトリを作成します。
    2. `make_cache_dir.py` を `--kb-root` に一時ディレクトリを指定して実行します。
    3. 指定した一時ディレクトリ内に `cache` という名前のディレクトリが作成されていることをアサートで検証します。

### 3. `entry_discovery.py` の単体テスト
- **テストファイル**: `test/test_entry_discovery.py` (更新)
- **目的**: ツールがカレントディレクトリではなく、`--path` 引数で指定されたナレッジベースルートの `discovery.json` を正しく更新できることを確認します。
- **テスト手順**:
    1. `unittest.TestCase` を使用し、一時的なナレッジベースのディレクトリ構造（例: `/tmp/my_kb/`）を作成します。
    2. `entry_discovery.py` を `--path /tmp/my_kb` と他の必須引数を指定して実行します。
    3. `/tmp/my_kb/discovery.json` が作成または更新され、新しいエントリが正しく追加されていることをアサートで検証します。

## 実装状況
