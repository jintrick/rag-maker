# Issue v0.7.2

## 前提知識
- docs/Architecture/Architecture.md
- docs/issue/v0.7.1.md

## 経緯
v0.7.1 において `ragmaker-install-kb` ツールのパス解決と複数ソース対応を改善したが、実運用上の安全性において重大な懸念が残っている。特に、ターゲット KB に既存のドキュメント情報がある場合にそれを上書き破壊してしまう問題や、ファイルシステム上の衝突耐性、トランザクション性の欠如を解決し、商用品質の堅牢性を確保する。

## 現状の問題点
- ターゲットディレクトリに既に `catalog.json` が存在する場合、新規インストールによって既存のドキュメント情報が無警告で上書き消失する。
- ソースとターゲット間で同名の「ファイル」と「ディレクトリ」が衝突した場合、`safe_export` がエラーを投げて処理が中途半端に中断する。
- インストール中にエラーが発生した場合、一部のファイルだけがコピーされた不整合な状態でターゲットが放置される。
- `catalog.json` のメタデータに記録されるソースパスが絶対パスとして正規化されていない可能性がある。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] ターゲットに既存の `catalog.json` がある場合、それを読み込んで新しいドキュメントリストとマージ（非破壊的な更新）が行われている。
- [ ] ドキュメントのマージにおいて `path` をキーとし、重複する場合は新規ソース側を優先し、重複しない既存の情報は維持されている。
- [ ] `src/ragmaker/utils.py` の `safe_export` または `install_kb.py` 内で、ファイルとディレクトリの相互衝突を検知し、`force` 指定時は安全に置換されている。
- [ ] インストール処理中に例外が発生した場合、エラー内容と失敗したソースを明確に出力し、中途半端な状態であることを警告している。
- [ ] `catalog.json` の `metadata.sources` に、解決された絶対パス（`resolve()` 済み）が記録されている。
- [ ] `discovery.json` の `install_kb` の説明文が、カタログのマージ挙動を含めた最新の仕様に更新されている。
- [ ] プロジェクト全体の pytest を実行し、既存カタログとのマージ検証を含む全てのテストがパスしている。

## 解決策の概要
`install_kb.py` のカタログ保存処理を、単純な上書きから「既存読み込み＋マージ」に変更する。また、パスの絶対化を徹底し、ファイルシステム上の衝突を事前またはコピー中に解消するロジックを導入する。

## 解決策の詳細
- `src/ragmaker/tools/install_kb.py` の修正：
  - カタログ保存前に `target_root / "catalog.json"` の存在を確認する。
  - 存在する場合、その内容を読み込み、`documents` 配列を辞書化（キーは `path`）して、新しいドキュメント群とマージする。
  - メタデータの `sources` リストも既存のものがあれば結合し、重複を排除した上で全て絶対パスに変換する。
- 衝突処理の強化：
  - `shutil.copytree` の実行前に、ターゲット側に同名のファイルが存在し、ソース側がディレクトリである（またはその逆）ケースを明示的にチェックし、`force` があれば削除してからコピーを継続する。
- `src/ragmaker/utils.py` への貢献検討：
  - カタログのマージロジックを `merge_catalog_data(old_data, new_data)` として関数化し、再利用性を高める。
- `discovery.json` の修正：
  - `install_kb` ツールの `description` を「既存のカタログ情報がある場合は非破壊的にマージする」旨を含めた内容に更新する。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/install_kb.py`
- `src/ragmaker/utils.py`

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `test/test_install_kb.py` に、既にドキュメントが登録されているターゲット KB に対して別の KB をインストールし、既存のドキュメント情報が消えずに統合されていることを検証するテストを追加した。
- [ ] 同名のパスを持つドキュメントをインストールした際、情報の更新（上書き）が正しく行われることを検証した。
- [ ] ファイルとディレクトリの衝突が発生する環境で、`force` 指定時に正しく上書きインストールされることを検証した。
- [ ] `pytest test/test_install_kb.py` を実行し、全テストのパスを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] <!-- 完了したマイルストーンを記述 -->
