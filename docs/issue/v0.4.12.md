# Issue v0.4.12: `html_to_markdown` ツールのリファクタリングとワークフローの整合性向上

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.md
- src/ragmaker/tools/html_to_markdown.py
- docs/issue/v0.4.9.md (一時ファイルを中心としたワークフローの思想)

## 経緯
`v0.4.9`のアーキテクチャ変更により、`/rag`コマンドのワークフローは「一時ファイル(`.tmp/discovery.json`)で全ての処理を完結させ、最後に完成品を正規の場所(`cache/`)に移動する」という思想で統一されました。これにより、ファイルI/Oが最適化され、ワークフローの見通しが大幅に改善されました。

しかし、`html_to_markdown`ツールだけがこの思想から取り残されています。現在のツールは、指定されたディレクトリ(`--target-dir`)内の`discovery.json`を直接探しに行き、その場で書き換える「インプレース更新」を行う仕様です。

## 現状の問題点
1.  **アーキテクチャとの不整合**: `html_to_markdown`のインプレース更新は、一時ファイル中心のワークフローと矛盾します。このツールを実行するためだけに、AIエージェントは未完成の`discovery.json`を`.tmp/`から`cache/`へ移動させるという、不自然で複雑な手順を踏む必要があります。
2.  **責務の曖昧さ**: ツールが「HTMLの変換」と「永続ファイルの直接編集」という2つの異なる責務を持ってしまっています。ツールは変換処理に専念し、ファイルの永続化はAIエージェントが`write_file`や`move_file`を使って制御するべきです。

## 解決策の概要
`html_to_markdown`ツールをリファクタリングし、インプレース更新のロジックを廃止します。
代わりに、ツールは**更新後の`discovery.json`の内容を標準出力に返す**ように変更します。これにより、他のデータ取得ツール(`http_fetch`など)と足並みが揃い、AIエージェントは一貫した方法でワークフローを制御できるようになります。

## 解決策の詳細
1.  **`html_to_markdown.py` の修正**:
    -   **引数の変更**:
        -   `--target-dir`を廃止し、より責務が明確な`--input-dir`（HTMLの場所）と`--discovery-path`（読み込む`discovery.json`のパス）を導入します。
    -   **ロジックの変更**:
        -   `--discovery-path`で指定されたファイルを読み込み、メモリ上で`path`キーの値を`.html`から`.md`に更新します。
        -   ファイルへの書き込みは行わず、更新後のJSONオブジェクト全体を`io_utils.print_json_stdout`を使って**標準出力**に書き出します。
        -   HTMLから変換したMarkdownファイルは、引き続き`--input-dir`内に生成し、元のHTMLは削除します。

2.  **`.gemini/commands/rag.md` のワークフロー修正**:
    -   `html_to_markdown`を実行するために`move_file`を呼び出していた複雑な手順を削除します。
    -   新しいワークフローは以下のようになります。
        1.  `http_fetch`の標準出力を`write_file`で`.tmp/discovery.json`に保存する。
        2.  `html_to_markdown`を呼び出す。
            -   `--input-dir`に`{{kb_root}}/cache/`を指定。
            -   `--discovery-path`に`.tmp/discovery.json`を指定。
        3.  `html_to_markdown`の標準出力（更新されたJSON文字列）をキャプチャする。
        4.  `write_file`を再度呼び出し、キャプチャした内容で`.tmp/discovery.json`を**上書き**する。
    -   これにより、`discovery.json`に関するすべての操作が`.tmp/`ディレクトリ内で完結します。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/html_to_markdown.py` (修正対象)
- `.gemini/commands/rag.md` (修正対象)
- `src/ragmaker/tools/http_fetch.py` (標準出力に返す挙動の参考)

## テスト方法
1.  **`html_to_markdown`の単体テスト (`test/test_html_to_markdown.py`) の修正**:
    -   ツールがファイルに書き込みを行わず、更新後のJSONを標準出力に正しく返すことを検証するテストに書き換えます。
    -   `--target-dir`の代わりに新しい引数を使うようにテストを修正します。
2.  **`/rag`コマンドの統合テスト**:
    -   Webソースを指定して`/rag`コマンドを実行します。
    -   AIエージェントのログを監視し、`discovery.json`を途中で`cache/`に移動させることなく、ワークフローが最後まで正常に完了することを確認します。
    -   最終的に生成された`cache/discovery.json`の`path`が正しく`.md`に更新されていることを確認します。

## 実装状況
