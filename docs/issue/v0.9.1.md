# Issue v0.9.1: AI Piloting Stabilization & Performance

## 前提知識
- `src/ragmaker/browser_manager.py` (改修対象)
- `src/ragmaker/tools/browser_open.py`, `browser_extract.py` (改修対象)
- `src/ragmaker/utils.py` (排他制御追加)
- `.gemini/commands/rag.md` (ドキュメント修正)

## 経緯
現在の AI Piloting (browser_*) ツール群は、各ツール呼び出しごとにブラウザを再起動しているため、オーバーヘッドが大きく、セッションの継続性も維持しにくい。また、`browser_extract` が直接 `catalog.json` を更新しており、単一責任原則（SRP）に反している。さらに、複数エージェントによる同時書き込み時の競合リスクがある。

## 現状の問題点
1. **パフォーマンス**: 抽出ループ（navigate -> extract）において、都度ブラウザを起動するため時間がかかる。
2. **設計の結合**: `browser_extract` がカタログ更新ロジックを内包しており、抽出と登録が分離されていない。
3. **信頼性**: Windows環境において、`catalog.json` への同時書き込みが発生した場合、ファイルが破損する可能性がある。
4. **不整合**: `rag.md` の指示と `discovery.json` の引数名（`--discovery-path` vs `--kb-root` / `--catalog-path`）に乖離がある。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `browser_open` が永続的なブラウザプロセスを起動（デタッチ）し、CDP接続情報を `.tmp/browser_cdp.json` に保存する。
- [x] `browser_navigate` および `browser_extract` が `.tmp/browser_cdp.json` を読み込み、既存のブラウザインスタンスに接続して動作する。
- [x] `browser_extract` からカタログ更新機能を削除し、抽出結果の返却のみに特化させる。
- [x] `src/ragmaker/utils.py` に `LockedJsonWriter` (Windows/Unix両対応のファイルロック) を実装し、カタログ更新時の排他制御を保証する。
- [x] `discovery.json` の引数名定義と `rag.md` の指示を完全に同期させる（特に `enrich_discovery` の `--catalog-path`）。
- [x] `entry_discovery` などのカタログ操作ツールが `LockedJsonWriter` を使用するように修正されている。

## 解決策の詳細

### 1. Browser Persistence (CDP Connection)
- **`src/ragmaker/browser_manager.py`**:
    - `launch_persistent_context` の代わりに `chromium.launch` を使用し、`args=['--remote-debugging-port=9222']` 等を指定して起動するロジックを追加。
    - 起動したブラウザの `ws_endpoint` を取得し、ファイルに保存する。
    - 既存のコンテキストに接続するための `connect_over_cdp` ラッパーメソッドを追加。
- **`src/ragmaker/tools/browser_open.py`**:
    - ブラウザをバックグラウンドプロセスとして起動（`subprocess.Popen` 等）し、プロセスIDとWSエンドポイントを `.tmp/browser_cdp.json` に保存する。
- **`src/ragmaker/tools/browser_close.py`**:
    - `.tmp/browser_cdp.json` を読み込み、保存されたPIDに対して終了シグナルを送る（またはPlaywright経由で終了させる）。

### 2. Decouple Extraction
- **`src/ragmaker/tools/browser_extract.py`**:
    - `--catalog-path` 引数を削除。
    - `update_catalog` 関数を削除。
    - 出力 JSON に `markdown_content`, `title`, `url`, `extracted_path` を含める。
    - **重要**: カタログへの登録責務はエージェントに移譲する。エージェントは抽出後、`entry_discovery` または `enrich_discovery` を呼び出す必要がある。

### 3. Catalog Safety (File Locking)
- **`src/ragmaker/utils.py`**:
    - `portalocker` などの外部ライブラリを使わず、標準ライブラリ（`msvcrt` for Windows, `fcntl` for Unix）を用いて `LockedJsonWriter` クラスを実装する。
    - `with LockedJsonWriter(path) as data: ...` のように使用できるコンテキストマネージャとする。

### 4. Documentation Consistency
- **`discovery.json`**:
    - `enrich_discovery` の引数を `--catalog-path` に統一。
    - `entry_discovery` の引数を `--catalog-path`（または `--kb-root` で統一し、内部で `catalog.json` を付加）に明確化。
- **`.gemini/commands/rag.md`**:
    - ツール呼び出しの引数名を `discovery.json` と完全に一致させる。
    - `browser_extract` の後にカタログ登録ステップを追加する。

## テスト方法
- [ ] `test/test_browser_persistence.py`: `browser_open` 後に `browser_navigate` を2回連続で実行し、PIDが変わっていない（同じブラウザである）ことを確認。
- [ ] `test/test_catalog_locking.py`: 複数のプロセスから同時に `LockedJsonWriter` を使用して書き込みを行い、データが損なわれないことを確認。
