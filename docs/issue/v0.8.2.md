# Issue v0.8.2: browser_fetch の高度なボット回避とセッション永続化の導入

## 前提知識
- `src/ragmaker/tools/browser_fetch.py`
- Playwright `launch_persistent_context` API
- Bot detection mechanisms (Cloudflare, etc.)

## 経緯
`v0.8.1` で導入した対話モード（非ヘッドレス）では、ページ遷移のたびにボット検知（CAPTCHA等）が発生し、ユーザーが都度 Enter キーを押下する必要があった。これはブラウザが自動操作ツールであることを隠蔽できていないこと、およびセッション情報（クッキー）が保持されていないことが原因である。本 Issue では、ステルス化、永続プロファイル、および検証画面の自動検知を導入し、ユーザー介入を最小限に抑えつつ確実にコンテンツを取得する。

## 現状の問題点
- ページ遷移ごとに CAPTCHA が再発し、自動化ツールとしての実用性を欠いている。
- `navigator.webdriver` フラグにより、ブラウザが「自動操作プログラム」であることが Web サイト側に容易に露呈している。
- ページごとにブラウザコンテキストを破棄しているため、一度パスした検証結果が維持されない。
- `headless=False` で実行した場合、リソース解放（close）が不十分だとブラウザプロセスが残存するリスクがある。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `WebFetcher` が `launch_persistent_context` を使用するように変更され、`.tmp/cache/browser_profile` にセッションが保存される。
- [x] `_close_browser` において、`self.context.close()` と `self.playwright.stop()` が正しく呼び出され、`self.browser` が `None` であるケース（persistent context の仕様）が考慮されている。
- [x] 固定された最新の User-Agent（Chrome/122.0.0.0等）が設定されている。
- [x] `navigator.webdriver` の隠蔽に加え、`navigator.languages`, `navigator.plugins`, `window.chrome` を模倣する高度な Stealth スクリプトが全ページに注入されている。
- [x] 以下のキーワードまたはセレクタによりボット対策画面（Cloudflare等）を検知し、非ヘッドレス時のみ自動でユーザー入力を待機する。
    - キーワード: `"Just a moment..."`, `"Checking your browser"`, `"Verify you are human"`, `"cf-challenge"`, `"ray_id"`
    - セレクタ: `#challenge-running`, `#challenge-form`, `.cf-browser-verification`, `.g-recaptcha`
- [x] ページ遷移の間に 1.0 〜 3.0 秒のランダムな待機時間（Human-like delay）が挿入されている。
- [x] `pytest test/test_browser_fetch.py` がパスし、`launch_persistent_context` のモックテストが含まれている。

## 解決策の概要
`WebFetcher` のブラウザライフサイクルを刷新し、物理的なプロファイルディレクトリを用いたセッション管理と、サイト側からの検知を回避する Stealth 機能を組み込む。

## 解決策の詳細

### 1. ブラウザの初期化と終了
- **`_setup_browser`**: 
    - `self.playwright.chromium.launch_persistent_context` を使用する。
    - `user_data_dir` に `.tmp/cache/browser_profile` を指定。
    - `user_agent` に `Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/122.0.0.0 Safari/537.36` を指定。
    - `viewport` を `{"width": 1280, "height": 720}` に固定。
- **`_close_browser`**:
    - `launch_persistent_context` を使用した場合、`browser` オブジェクトは返されないため、`self.context.close()` を実行することでブラウザも終了させる。
    - 最後に `self.playwright.stop()` を実行し、全てのプロセスを確実に終了させる。

### 2. ステルス化 (Bypass Bot Detection)
- **Init Script**: `page.add_init_script` を使用して、以下のスクリプトを注入する。
```javascript
() => {
    Object.defineProperty(navigator, 'webdriver', {get: () => undefined});
    Object.defineProperty(navigator, 'languages', {get: () => ['en-US', 'en']});
    window.chrome = { runtime: {} };
    Object.defineProperty(navigator, 'plugins', {get: () => [1, 2, 3, 4, 5]});
}
```

### 3. インテリジェント・ポーズ (Smart Wait)
- `_process_page` 内でコンテンツ抽出前に検知ロジックを走らせる。
- **検知条件**:
    - ページタイトルまたは `document.body.innerText` に以下の文字列が含まれる場合：
        - `"Just a moment..."`, `"Checking your browser"`, `"Verify you are human"`, `"Cloudflare"`
    - 以下のセレクタが存在する場合：
        - `#challenge-running`, `#challenge-form`, `.cf-browser-verification`
- **アクション**:
    - `no_headless` が `True` の場合、標準エラー出力に警告を出し、`sys.stdin.readline()` でユーザーの Enter 入力を待機する。
    - `no_headless` が `False` の場合、エラーとして処理し、そのページをスキップする。

### 4. ランダム待機
- `run` メソッドの `while` ループ内で、次の URL への `_process_page` 呼び出し直前に `await asyncio.sleep(random.uniform(1.0, 3.0))` を挿入。

## 参考とすべきスクリプト等
- [Playwright documentation: Persistent Context](https://playwright.dev/python/docs/api/class-browsertype#browser-type-launch-persistent-context)

## テスト方法
- `pytest test/test_browser_fetch.py` (モックの修正が必要)
- 実機テスト:
    - `python -m ragmaker.tools.browser_fetch --url https://vtolvr.wiki.gg/wiki/VTOL_VR_Wiki --base-url https://vtolvr.wiki.gg/ --output-dir .tmp/test_fetch --no-headless`
    - 初回で Cloudflare をパスした後、2ページ目以降で `[INTERACTIVE MODE]` が表示されずに自動進行することを確認する。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `launch_persistent_context` の導入完了
- [x] 高度な Stealth スクリプトの注入完了
- [x] ボット対策画面の自動検知およびポーズ機能の実装完了
- [x] ランダム待機の実装完了
- [x] 既存テストの修正と新規テストのパス完了
