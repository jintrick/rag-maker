# Issue v0.7.0

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.toml
- .gemini/commands/ask.toml

## 経緯
ユーザーが複数のナレッジベース（KB）を統合して一つのターゲットKBとして利用したいという要望がある。現在の `ragmaker-install-kb` は単一のソースKBのみをサポートしているため、これを拡張して複数ソースの一括インストール（マージ）を可能にする。

## 現状の問題点
- `ragmaker-install-kb` ツールの `--source` 引数が単一のパスしか受け付けない。
- 複数のKBを一つのディレクトリに統合してインストールする手段がない。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `src/ragmaker/tools/install_kb.py` が複数の `--source` 引数（`--source path1 path2 ...`）を受け取れるようになっている。
- [ ] 指定された全てのソースKBから `cache/` ディレクトリの内容がターゲットに統合（マージ）されている。
- [ ] 指定された全てのソースKBのカタログ（`catalog.json` または `discovery.json`）が読み込まれ、ターゲットの `catalog.json` に一つの `documents` 配列として統合されている。
- [ ] ターゲットの `catalog.json` 内の各ドキュメントの `path` が、ターゲットの `cache/` 以下を指すように正しく正規化されている。
- [ ] `discovery.json` の `install_kb` ツール定義における `source` 引数の型が `array` に更新されている。
- [ ] プロジェクト全体の pytest を実行し、新規追加分を含む全てのテストがパスしている。

## 解決策の概要
`ragmaker-install-kb` ツールを拡張し、複数のソースKBを一つのターゲットKBへ統合インストール可能にする。各ソースの `cache/` を `safe_export` でマージし、カタログ情報を結合してパスの整合性を維持する。

## 解決策の詳細
- `src/ragmaker/tools/install_kb.py` の修正：
    - `main` 関数内の `argparse` 設定で、`--source` に `nargs='+'` を指定し、リストとしてパスを受け取るように変更する。
    - `install_knowledge_base` 関数の第一引数 `source_root` を `source_roots: list[Path]` に変更する。
    - 処理フローを以下のように変更する：
        1. ターゲットディレクトリ（`target_root`）と `cache/` を作成する。
        2. `source_roots` をループし、各ソースについて：
            - `src/ragmaker/utils.py` の `safe_export` を用いて、ソースの `cache/` をターゲットの `cache/` にマージする。
            - ソースのカタログファイル（`catalog.json` > `discovery.json` の順で優先）を検索して読み込む。
            - 読み込んだカタログの `documents` 配列内の各項目のパスを、ターゲットの `cache/` からの相対パス（例: `cache/xxx/file.md`）に変換する。
            - 変換後のドキュメントリストを、ターゲット用の累積リストに追加する。
        3. 全てのソースの処理が終わった後、累積されたドキュメントリストを持つ `catalog.json` をターゲットルートに保存する。
- `discovery.json` の修正：
    - `install_kb` ツールの `parameters` 内の `source` の `type` を `array` に変更し、`items` を `string` に設定する。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/install_kb.py` (現在の単一ソース実装)
- `src/ragmaker/utils.py` ( `safe_export` 関数)

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `test/test_install_kb.py` を更新し、複数のソースKB（例: `source1` と `source2`）を一つのターゲットにインストールするテストケースを追加した。
- [ ] 統合後のターゲットKBにおいて、`catalog.json` に両方のソース由来のドキュメントが含まれていることを確認した。
- [ ] `pytest test/test_install_kb.py` を実行し、正常系および異常系（ソース不在など）のテストが全てパスすることを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] <!-- 完了したマイルストーンを記述 -->
