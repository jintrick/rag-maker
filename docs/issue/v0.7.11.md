# Issue v0.7.11

## 前提知識
- docs/Architecture/Architecture.md
- src/ragmaker/tools/install_kb.py

## 経緯
これまでの `ragmaker-install-kb` は、複数のソースが指定された場合にそれらを一つのターゲットディレクトリに強制的にマージ（統合）していた。しかし、これは利用者の意図に反してナレッジベースを破壊・混同させる「改悪」であった。本来のインストーラーの役割に基づき、各ソースを独立したサブディレクトリとして配置する挙動に修正し、マージは明示的なオプションとする。

## 現状の問題点
- 複数の KB を選択してインストールすると、全てのドキュメント情報が一つの `catalog.json` に混ぜ合わされてしまい、元の KB の独立性が失われる。
- 既存のプロジェクトディレクトリ内に、複数の KB を個別の構成要素として「並べてインストール」することができない。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `src/ragmaker/tools/install_kb.py` のデフォルト挙動が、各ソースを `target_root / source_name` というサブディレクトリに個別にインストールするようになっている。
- [ ] 引数 `--merge` が追加され、このフラグが指定された場合のみ、従来の「全ソースを一つに統合する」挙動が動作する。
- [ ] インストール処理のループにおいて、各ソースごとの原子性（一時ディレクトリを使用した安全なインストール）が維持されている。
- [ ] `discovery.json` の `install_kb` 定義に `merge` パラメータが追加され、説明文が更新されている。
- [ ] プロジェクト全体の pytest を実行し、新規追加分を含む全てのテストがパスしている。

## 解決策の概要
インストール先の決定ロジックを、デフォルトでは「ソース名によるサブディレクトリ化」に変更する。共有ターゲットへのマージは `--merge` オプションによって制御する。

## 解決策の詳細
- `src/ragmaker/tools/install_kb.py` の修正：
  - `main` 関数で `--merge` 引数を追加。
  - `install_knowledge_base` 関数を、`merge: bool` に応じて以下の 2 パターンの制御構造に分ける。
  - **パターン A (デフォルト: merge=False)**:
    - 処理ループ内で、個々の `source_root` ごとに `temp_dir` を作成し、`target_root / source_root.name` への原子的なインストール（ファイルコピー ＋ カタログ生成）を完結させる。
  - **パターン B (merge=True)**:
    - 従来のロジック通り、全ソースを一つの `temp_dir` に集約し、最後に単一の `target_root` として差し替える。
- `discovery.json` の更新。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/install_kb.py` (v0.7.10 時点の実装)

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `test/test_install_kb.py` を更新し、複数ソース指定時にデフォルトで個別のフォルダが作られることを検証した。
- [ ] `--merge` フラグ有効時に、一つのカタログに正しく統合されることを検証した。
- [ ] `pytest` を実行し、全 16 項目（以上）のテストパスを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] <!-- 完了したマイルストーンを記述 -->
