# Issue v0.6.1.6: 破壊的操作の一掃と安全なエクスポート機能の共通化

## 前提知識
- src/ragmaker/tools/github_fetch.py
- src/ragmaker/tools/file_sync.py
- src/ragmaker/tools/install_kb.py
- src/ragmaker/utils.py

## 用語の定義
- **破壊的操作**: `shutil.rmtree` 等を用い、出力先ディレクトリを事前に全削除する行為。
- **安全なエクスポート**: 既存のファイルを破壊せず、成果物のみをマージ（上書き・追加）する処理。

## 経緯
`github_fetch.py` を含む複数のツールにおいて、出力先を事前に `shutil.rmtree` で削除するという致命的なデータ消失リスクを孕む実装が発見された。これは設計上の悪習であり、プロジェクト全体の信頼性を著しく損なう。これを一掃し、内部一時領域の活用と安全なエクスポート処理を共通化することで、システムの堅牢性を抜本的に強化する。

## 現状の問題点
- **データ消失リスク**: `github_fetch.py`, `file_sync.py`, `install_kb.py` 等が、ユーザー指定の出力先を無条件で削除しており、誤操作時に取り返しのつかない被害をもたらす。
- **設計の不統一**: 各ツールが独自に危険なクリーンアップを行っており、共通の安全なファイル配置ロジックが存在しない。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `src/ragmaker/utils.py` に、既存ファイルを破壊せずにディレクトリ内容をマージする共通関数 `safe_export(src, dst)` が実装されている。
- [ ] 以下のツールのコードから、ユーザー指定パスに対する `shutil.rmtree` 等の破壊的操作が完全に削除されている。
    - `src/ragmaker/tools/github_fetch.py`
    - `src/ragmaker/tools/file_sync.py`
    - `src/ragmaker/tools/install_kb.py`
    - `src/ragmaker/tools/init_cache.py`
- [ ] `github_fetch.py` および `file_sync.py` の内部工程が、`tempfile.TemporaryDirectory` による隔離領域で完結し、最後に `safe_export` で成果物のみを提供している。
- [ ] `pytest` を実行し、全テストケースがパスしている。

## 解決策の概要
「事前削除」を禁止し、共通ユーティリティ `safe_export` による「安全なマージ」へと移行する。各ツールは内部作業に一時ディレクトリを使い、ユーザー環境を汚染・破壊しないプロフェッショナルな設計を徹底する。

## 解決策の詳細
### 1. 共通ユーティリティの導入 (`src/ragmaker/utils.py`)
- `safe_export(src_dir: Path, dst_dir: Path)` を実装。
- `shutil.copytree(src_dir, dst_dir, dirs_exist_ok=True)` または個別の `copy2` 処理により、既存ディレクトリを削除せず、中身を上書き・追加するロジックを担保する。

### 2. 各ツールのリファクタリング
- **`github_fetch.py`**: 作業全般を内部 `TemporaryDirectory` で行い、最後に `safe_export` で出力先へ反映する。
- **`file_sync.py`**: `shutil.rmtree(dest_dir)` を廃止し、`safe_export` に置き換える。
- **`install_kb.py`**: `shutil.rmtree(target_cache)` を廃止し、必要に応じてマージ、または安全な置換を行う。

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] 各ツールにおいて、出力先に `pre-existing.txt` を置いた状態で実行し、そのファイルが削除されずに残ることを確認した。
- [ ] `safe_export` 単体のユニットテストを追加し、マージ動作が正常であることを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] v0.6.1.6 起草
- [ ] `utils.py` への `safe_export` 実装完了
- [ ] `github_fetch.py` の安全化リファクタリング完了
- [ ] `file_sync.py` / `install_kb.py` 等の破壊的操作削除完了
- [ ] 全テストのパスおよび既存データ保護の最終確認完了
