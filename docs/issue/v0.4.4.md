# Issue v0.4.4: `html_to_markdown` ツールのロジック修正と堅牢性の向上

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.toml
- src/ragmaker/tools/http_fetch.py
- src/ragmaker/tools/html_to_markdown.py

## 経緯
`/rag` コマンドのワークフローにおいて、`http_fetch` ツールでWebページからHTMLファイル群をキャッシュディレクトリに取得した後、後続の `html_to_markdown` ツールを実行しても、HTMLファイルが一切Markdownに変換されないという問題が発覚しました。
ツールはエラーを報告せず、`{"converted_files": [], "errors": []}` という空の結果と共に `status: "success"` を返してしまうため、ワークフローが静かに失敗していました。

## 現状の問題点
1.  **ツールの期待するデータ構造の不一致**:
    -   `http_fetch` ツールは、取得したHTMLファイルのパスをキャッシュディレクトリ内の `discovery.json` に `{ "path": "page_0.html", ... }` という形式で記録します。
    -   一方、現在の `html_to_markdown` ツールは、変換対象のHTMLファイルを `{ "html_path": "page_0.html", ... }` という `html_path` キーで探します。
    -   このキーの不一致により、`html_to_markdown` は変換すべきファイルを一つも見つけられずに処理を終えてしまいます。

2.  **不適切な成功ステータス**:
    -   変換対象が一つも見つからなかった場合でも、処理中に例外が発生しなければ `status: "success"` を返してしまいます。これは、実質的に何もしていないにもかかわらず成功したと報告するものであり、ワークフローのデバッグを困難にしています。

## 解決策の概要
`html_to_markdown.py` のロジックを修正し、他のツールとの連携をスムーズにします。具体的には、`discovery.json` 内の `path` キーを直接参照して変換対象を判断するように変更し、変換が一件も行われなかった場合のステータスレポートをより実態に即したものに改善します。

## 解決策の詳細
1.  **`html_to_markdown.py` のロジック修正**:
    -   `html_path` キーを探すロジックを完全に廃止します。
    -   代わりに、`documents` 配列内の各エントリを走査し、`path` キーの値が `.html` または `.htm` で終わるものを変換対象とします。
    -   変換が成功した場合、元のHTMLファイルを削除し、同じ `path` キーの値を、拡張子を `.md` に変更した新しいパスにインプレースで更新します。
    -   変換処理が1件も実行されなかった場合、`status` を `success` ではなく `no_action_needed` のような、より実態に即した値で報告するように変更します。
    -   変換が1件以上成功し、かつエラーも発生した場合は `partial_success` を維持します。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/html_to_markdown.py` (修正対象)
- `src/ragmaker/tools/http_fetch.py` (入力データ生成の参考)
- `test/test_html_to_markdown.py` (修正・拡充対象)

## テスト方法
`test/test_html_to_markdown.py` を修正または新規作成し、以下のシナリオを網羅するテストを実装します。

1.  **正常変換ケース**:
    -   `http_fetch` が生成する形式（`path` キーに `.html` パスが記録されている）の `discovery.json` を用意します。
    -   ツール実行後、`.html` ファイルが `.md` ファイルに変換され、元のファイルが削除されていることを確認します。
    -   `discovery.json` の `path` キーが `.md` パスに正しく更新されていることを確認します。
    -   出力JSONの `status` が `success` であることを確認します。
2.  **対象なしケース**:
    -   `discovery.json` に `.html` ファイルのエントリが存在しない状態でツールを実行します。
    -   ファイルが何も変更されないことを確認します。
    -   出力JSONの `status` が `no_action_needed` (またはそれに準ずる新しいステータス) であることを確認します。

## 実装状況


