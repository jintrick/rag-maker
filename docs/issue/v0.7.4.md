# Issue v0.7.4

## 前提知識
- docs/Architecture/Architecture.md
- docs/issue/v0.7.3.md
- PR #65 での Gemini Code Assist による高優先度の指摘事項

## 経緯
v0.7.3 において `ragmaker-install-kb` の原子性を確保する実装を行ったが、一時ディレクトリの作成場所に不備があり、別デバイスへのインストール時に原子性が崩れるリスク（gca 指摘）が残っている。また、バックアップからの復元失敗時の対応を強化し、ツールの堅牢性を最終的に完成させる。

## 現状の問題点
- `tempfile.TemporaryDirectory()` に `dir` 引数が指定されていないため、システムのデフォルト一時領域が使用される。ターゲットが別ドライブにある場合、アトミックな `os.rename` が行われず、データ不整合のリスクがある。
- インストール失敗時のバックアップからの復元（`.bak` の書き戻し）自体が失敗した場合、ユーザーに対してデータの所在（`.bak` に残っていること）を伝える明示的な通知がない。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `src/ragmaker/tools/install_kb.py` において、一時ディレクトリが常に `target_root.parent` 配下に作成されるよう修正されている。
- [ ] 一時ディレクトリ作成前に `target_root.parent` が存在することを保証するロジックが追加されている。
- [ ] バックアップ（`.bak`）からの復元に失敗した際、エラーの詳細と「データが `.bak` ディレクトリに退避されたままであること」を警告するログが出力されている。
- [ ] プロジェクト全体の pytest を実行し、新規追加分を含む全てのテストがパスしている。

## 解決策の概要
一時ディレクトリの作成場所をターゲットと同一デバイスに限定することで真の原子性を確保し、エラーリカバリ時の通知を強化してデータ消失誤認を防止する。

## 解決策の詳細
- `src/ragmaker/tools/install_kb.py` の修正：
  - `tempfile.TemporaryDirectory` の呼び出し箇所を `with tempfile.TemporaryDirectory(dir=target_root.parent) as temp_dir:` に変更する。
  - その直前で `target_root.parent.mkdir(parents=True, exist_ok=True)` を実行し、作成を確実にする。
  - `except Exception:` ブロック内での復元処理（`backup_path.rename(target_root)`）を `try-except` で囲み、失敗した場合は `logger.critical` 等で「復元に失敗したためデータは {backup_path} に残っている」旨を詳細に出力する。
- `discovery.json` の確認：
  - 必要に応じて説明文を微調整するが、基本は現状維持で問題ない。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/install_kb.py` (v0.7.3 時点の実装)
- PR #65 の Gemini Code Assist 指摘コメント

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `test/test_install_kb.py` において、一時ディレクトリが意図した場所（`target_root.parent`）に作られていることを（モック等を利用して）検証した。
- [ ] 復元失敗のシナリオを擬似的に再現し、適切な警告ログが出力されることを確認した。
- [ ] `pytest` を実行し、全てのテストがパスすることを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] <!-- 完了したマイルストーンを記述 -->
