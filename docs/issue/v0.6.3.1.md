# Issue v0.6.3.1

## 前提知識
- docs/issue/v0.6.2.md
- src/ragmaker/tools/ask_dir.py
- src/ragmaker/tools/install_kb.py
- .gemini/skills/rag-installer/SKILL.md

## 用語の定義
- **ターゲット親ディレクトリ**: ユーザーがダイアログで選択した、KBの配置先となるディレクトリ。

## 経緯
v0.6.3 において導入したパス計算ロジック（ソースフォルダ名の維持など）をプロンプト（SKILL.md）上で実装したが、AIエージェントの推論能力に依存した結果、ハルシネーションが発生し、意図しないディレクトリ構造が作成される事態となった。また、相対パスの解決がスクリプト側で不十分であった。

## 現状の問題点
- **推論依存のパス計算**: エージェントがパスを文字列操作で結合しようとするため、環境や入力によって結果が不安定になる。
- **相対パスの解決不備**: `ragmaker-ask-dir --initial-dir .` が正しく現在の作業ディレクトリをダイアログの初期位置として反映しない。
- **スキルの肥大化**: プロンプトにロジックを書き込みすぎたため、スキルの保守性が低下し、エージェントの誤動作を招いている。

## ゴール（完了の定義）
- [x] `ragmaker-ask-dir` が `initial_dir` を絶対パスに正規化してから GUI を開くよう修正されている。
- [x] `ragmaker-install-kb` が、ターゲットが既存ディレクトリの場合にソースのフォルダ名を維持する（サブディレクトリを作成する）ロジックを内包する。
- [x] `SKILL.md` からパス計算などの「演算」を排除し、ツールのオーケストレーションとユーザー確認のみに特化させる。

## 解決策の詳細
1. **`ask_dir.py`**: 
   - `initial_dir` を `os.path.abspath` でラップし、確実なパス解決を行う。
2. **`install_kb.py`**:
   - `target_kb_root` がディレクトリとして存在する場合、`target_kb_root = target_kb_root / source_root.name` と自動計算する。
   - これにより、エージェントがパスを弄る必要を無くす。
3. **`SKILL.md`**:
   - 指示を極小化。ツールを実行し、その結果（または予定される動作）をユーザーに伝えて確認を得る、という「手順」のみを記述。

## テスト方法
- [x] `ragmaker-ask-dir --initial-dir .` で期待通りのディレクトリが開くか。
- [x] `ragmaker-install-kb` がディレクトリ指定時にサブディレクトリを自動生成するか。
- [x] スキルを介した対話で、エージェントが計算ミスを犯す余地がなくなっているか。

## 実装状況
- [ ] `ask_dir.py` の修正
- [ ] `install_kb.py` のロジック改善
- [ ] `SKILL.md` の極小化
- [ ] スキルの再配布
