# Issue v0.7.6

## 前提知識
- docs/Architecture/Architecture.md
- src/ragmaker/tools/ask_dir.py
- PR #67 での Gemini Code Assist による指摘事項

## 経緯
v0.7.5 において `ask_dir` の複数選択機能を実装したが、COM オブジェクトのライフサイクル管理や戻り値の型の一貫性に改善の余地があることが判明した（gca 指摘）。本 issue では、これらの設計上の不備を修正し、商用ソフトウェアとしての堅牢性を完成させる。

## 現状の問題点
- `pythoncom.CoUninitialize()` が `except` ブロックごとに記述されており、予期せぬ例外時にリソースリークが発生するリスクがある。
- `--multiple` 指定時でも、フォールバック経路によっては戻り値のキーが `selected_directory` (String) になる場合があり、呼び出し側のパースを複雑にしている。
- 内部ロジックにおいて、既に型が確定している変数に対して冗長な `isinstance` チェックが行われている。
- テストコードにおいて、フォールバックの前提条件（`PYWIN32_AVAILABLE == False`）が明示的に検証されていない。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `_ask_directory_windows` 内で `try...finally` を使用し、例外の有無に関わらず確実に `CoUninitialize` が呼ばれるようになっている。
- [ ] `multiple=True` が指定された場合、出力 JSON は常に `selected_directories` キーを持ち、値は必ずリスト（配列）形式である。
- [ ] 既存の冗長な型チェック（`isinstance`）が排除され、見通しの良いコードになっている。
- [ ] `test/test_ask_dir.py` のフォールバックテストにおいて、`PYWIN32_AVAILABLE` が期待通り `False` であることがアサーションされている。
- [ ] プロジェクト全体の pytest を実行し、全てのテストがパスしている。

## 解決策の概要
COM の初期化・解放を Python 規定の `try...finally` パターンへ修正し、戻り値のデータ構造を引数フラグに基づいて完全に一貫させる。また、テストコードの妥当性をアサーションによって強化する。

## 解決策の詳細
- `src/ragmaker/tools/ask_dir.py` の修正：
  - `pythoncom.CoInitialize()` の直後に `try:` を開始し、`finally: pythoncom.CoUninitialize()` で確実に閉じる。
  - `ask_for_directory` 関数内の最終出力ロジックを整理し、`multiple` フラグが真なら常に `[selected]` としてラップし、キーを `selected_directories` に固定する。
  - `isinstance(selected, list)` 等の二重チェックを削除する。
- `test/test_ask_dir.py` の修正：
  - gca の指摘通り、`self.assertFalse(ask_dir.PYWIN32_AVAILABLE)` を追加してテストの前提条件を明示する。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/ask_dir.py` (v0.7.5 時点の実装)
- PR #67 の Gemini Code Assist 指摘コメント

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `pytest test/test_ask_dir.py` を実行し、戻り値のキー名と型が一貫していることを確認した。
- [ ] Windows 以外のプラットフォーム（またはモック環境）でのフォールバック時に、正しく警告が出て、かつリスト形式で結果が返ることを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] <!-- 完了したマイルストーンを記述 -->
