# Issue v0.7.9

## 前提知識
- src/ragmaker/tools/ask_dir.py
- Windows API IFileOpenDialog 仕様（FOS_PICKFOLDERS と FOS_ALLOWMULTISELECT の競合）

## 経緯
v0.7.8 の修正では、`multiple=True` 時に `FOS_PICKFOLDERS` を無効化する処理が不完全であったため、Windows OS が依然として「単一フォルダ選択」モードを優先し、複数選択ができない状態が続いていた。フラグのビット演算を厳密化し、確実に複数選択を有効化する。

## 現状の問題点
- `--multiple` を指定しても、ダイアログ上で複数のフォルダをハイライト選択できない。
- これは `dialog.GetOptions()` で取得したデフォルト値に含まれる `FOS_PICKFOLDERS` ビットがクリアされていないことが原因である可能性が高い。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `src/ragmaker/tools/ask_dir.py` の `_ask_directory_windows` 関数において、`multiple=True` の時に `FOS_PICKFOLDERS` フラグを**明示的にクリア（ビット反転AND）**している。
- [ ] `FOS_ALLOWMULTISELECT` と `FOS_FORCEFILESYSTEM` がセットされ、かつ `FOS_PICKFOLDERS` がオフの状態でダイアログが開いている。
- [ ] Windows 環境で、複数のフォルダをハイライトして「開く（Open）」ボタンを押すことで、それらのパスが配列として取得できる。
- [ ] 取得したパスのリストに対し、引き続き `os.path.isdir` によるフィルタリングが行われている。
- [ ] プロジェクト全体の pytest を実行し、全テストがパスしている。

## 解決策の概要
フラグのビット演算を `options &= ~shellcon.FOS_PICKFOLDERS` のように記述し、競合するモードを確実に排除する。これにより、OS 標準の複数アイテム選択機能を「ファイル選択モード」として呼び出し、中身からディレクトリを抽出する。

## 解決策の詳細
- `src/ragmaker/tools/ask_dir.py` 修正：
  - `multiple` フラグに応じて、対象ビットを立てるだけでなく、不要なビットを下ろす処理を徹底する。
- `test/test_ask_dir.py` 修正：
  - セットされたフラグの組み合わせが、排他条件を満たしていることを検証するアサーションを追加。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/ask_dir.py` (現在の実装)

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] Windows 環境で `ragmaker-ask-dir --multiple` を実行し、実際に複数のフォルダを選択・確定してパスが取得できることを目視確認した。
- [ ] `pytest test/test_ask_dir.py` を実行し、全テストのパスを確認した。
