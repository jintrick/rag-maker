# Issue v0.4.19

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.md

## 経緯
`v0.4.15`にて、`http_fetch.py`ツールにMozillaの`Readability.js`を外部コマンド(`readable-cli`)として呼び出す機能が実装されました。これにより、Webページから高品質な本文コンテンツを抽出することが可能になりました。
このツールは`subprocess.run`を用いて`readable-cli`を実行し、その標準出力（`stdout`）から抽出されたHTMLコンテンツを取得しています。

## 現状の問題点
`readable-cli`は、本文抽出自体は成功しているにもかかわらず、Webページに含まれるCSSのパースエラーなど、本文抽出のタスクとは直接関係のない軽微なエラーや警告を標準エラー出力（`stderr`）に大量に出力することがあります。

現在の`http_fetch.py`の実装では、`subprocess.run`で`stdout`と`stderr`の両方をキャプチャしています。その結果、AIエージェントは正常な`stdout`（抽出されたHTML）と、大量の`stderr`（無関係なエラーログ）の両方を受け取ってしまいます。

これにより、AIエージェントが`stderr`の内容を重大な実行時エラーと誤認し、本来は成功しているにもかかわらずワークフローを異常終了させようとしたり、混乱して後続の処理に失敗したりする原因となっています。

## 解決策の概要
`http_fetch.py`が`readable-cli`を呼び出す際に、標準エラー出力(`stderr`)を完全に無視するように変更します。

`readable-cli`からの正常な標準出力(`stdout`)のみをキャプチャすることで、AIエージェントは本文抽出の成功/失敗を`stdout`の有無と終了コードのみで判断できるようになり、無関係なエラー情報に混乱することがなくなります。


## 解決策の詳細
`src/ragmaker/tools/http_fetch.py`の`_extract_and_convert`メソッド内にある`subprocess.run`の呼び出しを修正します。

1.  `subprocess.run`の引数に`stderr=subprocess.DEVNULL`を追加します。これにより、`readable-cli`が`stderr`に出力するすべての内容は破棄され、Pythonプロセスには渡されなくなります。
2.  `subprocess.CalledProcessError`の例外処理ブロックを修正します。`stderr`をキャプチャしなくなるため、エラーログから`e.stderr`への参照を削除し、代わりに終了コード(`e.returncode`)を記録するように変更します。

## 参考とすべきスクリプト等
`src/ragmaker/tools/http_fetch.py`

## テスト方法
1.  **テストフィクスチャの準備**: `test/fixtures/` ディレクトリに、意図的に不正なCSS構文を含むHTMLファイル (`invalid_css.html` など) を新規作成します。このHTMLは、`readable-cli`が`stderr`にCSSパースエラーを出力するものの、本文抽出自体は成功するような内容とします。
2.  **`test/test_http_fetch.py` の拡張**:
    -   既存のテストクラス `TestHttpFetchTool` に、新しいテストメソッドを追加します。
    -   このテストメソッドは、`invalid_css.html` をローカルHTTPサーバー経由で配信するURL (`http://localhost:8000/invalid_css.html` など) をツールに渡して実行します。
    -   **検証項目**:
        -   ツールの実行時に `stderr` に何も出力されないこと（`subprocess.DEVNULL`によって破棄されるため）。
        -   ツールが `subprocess.CalledProcessError` を発生させることなく正常に終了すること。
        -   `stdout` に正しいJSONが出力され、指定した `output-dir` に本文が抽出されたMarkdownファイルが正しく生成されていること。

## 実装状況