# Issue v0.4.17: `file_sync`へのドキュメント変換機能の統合と全ワークフローの統一

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.md
- `docs/issue/v0.4.15.md`: `http_fetch`への変換機能統合
- `docs/issue/v0.4.16.md`: `github_fetch`への変換機能統合

## 経緯
`v0.4.15`および`v0.4.16`の実装により、`http_fetch`と`github_fetch`ツールは、それぞれHTMLからMarkdownへの変換機能を内包する自己完結したツールへと進化しました。これにより、WebソースおよびGitHubソースからのデータ取得ワークフローは大幅に簡素化されました。

しかし、ローカルディレクトリを扱う`file_sync`ツールだけが、依然としてファイルの同期（コピー）のみを行う仕様のまま取り残されています。
## 現状の問題点
1.  **ワークフローの不整合**: ローカルディレクトリをソースとした場合のみ、後続の「ステップ2. データ変換」と「ステップ3. キャッシュクリーンアップ」が別途必要となり、AIエージェントのワークフローに非効率な分岐と複雑性が生じています。
2.  **責務の分散**: 「ファイルの同期」と「ファイルの変換」という密接に関連する処理が、`file_sync`と`html_to_markdown`/`document_converter`という複数のツールに分散しており、メンテナンス性を低下させています。

## 解決策の概要
`file_sync`ツールをリファクタリングし、ファイルの同期処理中にドキュメント変換機能を実行するように責務を拡張します。

具体的には、コピー対象のファイルの拡張子を判別し、HTMLやPDF、Word文書などのサポート対象ファイルであれば自動的にMarkdownへ変換して保存します。これにより、ローカルディレクトリをソースとした場合でも後続の変換ステップが不要になり、**すべてのソースタイプでデータ取得ワークフローが完全に統一**されます。

## 解決策の詳細
1.  **`file_sync.py` の修正**:
    -   **変換ロジックの統合**: ファイルをコピーするループ内で、ファイルの拡張子をチェックするロジックを追加します。
        -   `.html`, `.htm` の場合: `github_fetch`と同様に、`readabilipy`ライブラリを使ってMarkdownに変換します。
        -   `.pdf`, `.docx`, `.pptx` などの場合: `document_converter`ツールのロジックを参考に、`markitdown`や`yomitoku`ライブラリを使ってMarkdownに変換します。
        -   `.md`, `.txt` など、変換が不要なファイルの場合は、そのままコピーします。
    -   **出力パスの調整**: 変換されたファイルは、元の拡張子を`.md`に変更して保存します。
    -   **標準出力JSONの更新**: `documents`配列に記録する`path`キーには、最終的に`output-dir`に保存されたファイル名（変換後は`.md`）を記録するようにします。

2.  **`.gemini/commands/rag.md` のワークフロー簡素化**:
    -   `#### C) ローカルディレクトリの場合` のフローを修正します。
    -   「1. ファイル同期」を「1. データ取得と変換」に名称変更します。
    -   「3. 次のステップへ」の指示を、他のフローと同様に「**ステップ2と3は不要**です。**ステップ4. ドキュメントのエンリッチ** に進んでください。」という指示に統一します。

## テスト方法
1.  **`file_sync.py` の単体テストの拡充**:
    -   **テストフィクスチャの準備**: 以下のファイルを含むテスト用のディレクトリを準備します。
        -   変換対象のHTMLファイル (`sample.html`)
        -   変換対象のPDFファイル (`sample.pdf`)
        -   変換対象のWord文書 (`sample.docx`)
        -   そのままコピーされるMarkdownファイル (`readme.md`)
        -   そのままコピーされるテキストファイル (`notes.txt`)
        -   無視される非対応ファイル (`image.jpg`)
    -   **検証項目**:
        -   ツール実行後、出力ディレクトリに`sample.md` (HTMLから)、`sample.md` (PDFから)、`sample.md` (Wordから) が正しく生成されていること。
        -   `readme.md`と`notes.txt`が内容を変更されずにコピーされていること。
        -   `image.jpg`がコピーされていないこと。
        -   標準出力されるJSONの`documents`配列の`path`が、正しく最終的なファイル名を指していること。

2.  **`/rag` コマンドの統合テスト**:
    -   上記テストフィクスチャのディレクトリを対象に`/rag`コマンドを実行します。
    -   AIエージェントのログを監視し、`file_sync`の後に`html_to_markdown`や`document_converter`が呼び出されることなく、ワークフローが正常に完了することを確認します。

## 実装状況