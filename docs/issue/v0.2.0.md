# Issue v0.2.0: HTML to Markdown変換ツールの実装

## 前提知識
- `docs/Architecture/Architecture.md`

## 現状の問題点
- - HTMLには不要なタグやスタイル情報が多く含まれており、そのままAIエージェントに渡すとノイズとなり、トークン消費も増大する。
- `/rag` コマンドがWebページから情報を収集する際、取得したHTMLコンテンツをAIエージェントが処理しやすいMarkdown形式に変換するツール`tools/html_to_markdown.py`があるが、現在仕様に準拠していない。


## 解決策の概要
- HTMLコンテンツをクリーンなMarkdown形式に変換し、指定されたディレクトリに保存するPythonスクリプト `html_to_markdown.py` を仕様に準拠させる。
- このツールは、Webページからのデータ収集フローの一部として使用される。
- 変換されたファイルのリストと、抽出されたタイトルをJSON形式で出力する。

## 解決策の詳細
`html_to_markdown.py` は、以下の仕様を満たすツールとして実装されなければならない。

1.  **入力**:
    - `--input-dir`: 変換対象のHTMLファイルが格納されたディレクトリのパス。
    - `--output-dir`: 変換されたMarkdownファイルを保存するディレクトリのパス。
    - `--base-url` (オプション): リンクの相対パスを絶対パスに変換するためのベースURL。
2.  **変換処理**:
    - `--input-dir` 内のすべてのHTMLファイル（`.html`, `.htm`）を再帰的に検索する。
    - 各HTMLファイルをパースし、不要なタグ（`script`, `style`など）や属性を除去し、本文コンテンツを抽出する。
    - 抽出した本文をMarkdown形式に変換し、`--output-dir` 内の対応するパスに `.md` ファイルとして保存する。
    - 変換後のMarkdownは、AIエージェントが読みやすいように整形する（余分な空白行の削除、リストの整形など）。
    - リンクの修正（相対パスの絶対パス化、`.html`拡張子の`.md`化）を行う。
3.  **結果の出力**: 変換処理の概要と、変換された各ファイルの情報をJSON形式で標準出力に返す。
    ```json
    {
      "status": "success",
      "input_directory": "...",
      "output_directory": "...",
      "converted_files": [
        {
          "original_path": "...",
          "converted_path": "...",
          "title": "..."
        },
        ...
      ],
      "errors": [
        {
          "file_path": "...",
          "message": "..."
        }
      ]
    }
    ```
    - `title` は、HTMLから抽出されたタイトルを使用する。
4.  **作法**: エラーハンドリングや引数解析は、既存のツール（例: 旧 `make_vector_db.py`）の堅牢な作法を踏襲する。

## ツールの習性 (Tool Characteristics)
本ツールは、AIエージェントによる利用を前提としており、以下の習性を厳守すること。

1.  **堅牢なエラーハンドリング:**
    *   予期せぬエラーや無効な入力があった場合、処理を中断し、構造化されたJSON形式のエラーメッセージを標準エラー出力 (`sys.stderr`) に出力すること。
    *   エラーメッセージには、`status: "error"`, `error_code`, `message`, `remediation_suggestion` (修正提案), `details` (詳細情報) を含めること。
    *   エラー発生時は、ゼロ以外の終了コード (`sys.exit(1)`) で終了すること。
2.  **明確な成功出力:**
    *   処理が正常に完了した場合、結果を構造化されたJSON形式で標準出力 (`sys.stdout`) に出力すること。
    *   成功メッセージには、`status: "success"` と、処理結果に関する必要な情報を含めること。
3.  **依存関係の明示とチェック:**
    *   必要な外部ライブラリは、スクリプトの冒頭で `try-except ImportError` ブロックを用いて存在チェックを行い、不足している場合は適切なエラーメッセージと共に終了すること。
4.  **ロギング:**
    *   処理の進行状況や警告、デバッグ情報は、`logging` モジュールを用いて標準エラー出力に適切に出力すること。
    *   `f-string` ではなく、遅延評価形式（例: `logger.info("メッセージ: %s", 変数)`）を使用すること。
5.  **引数解析:**
    *   `argparse` モジュールを用いてコマンドライン引数を堅牢に解析し、無効な引数や不足している引数があった場合は、構造化されたエラーメッセージと共に終了すること。
6.  **冪等性 (Idempotency):**
    *   同じ入力に対して複数回実行しても、同じ結果が得られるように設計すること。
    *   既存のファイルを上書きする際は、その動作を明確にすること。

## 参考とすべきスクリプト等
- (旧) `make_vector_db.py`: エラーハンドリング、引数解析、JSON出力形式などの作法を参考に。
- `samples/gemini_cli_discovery.json`: 出力JSONの `documents` 配列の各エントリの `path`, `title` の参考。

## テスト方法
`html_to_markdown.py` の機能が正しく動作することを確認するため、以下のテストを実施する。

1.  **サンプルHTMLディレクトリの準備**: テスト用のHTMLファイルを含むディレクトリを用意する。
2.  **ツール実行**: `html_to_markdown.py` を、サンプルHTMLディレクトリと出力ディレクトリを引数として実行する。
    - 例: `python html_to_markdown.py --input-dir "path/to/html_docs" --output-dir "path/to/md_docs"`
3.  **出力確認**:
    - 標準出力に、`status: success` を含むJSONが返されることを確認する。
    - `converted_files` 配列に、変換されたファイルのパスとタイトルが正しく含まれていることを確認する。
    - `--output-dir` にMarkdownファイルが正しく生成されていることを確認する。
