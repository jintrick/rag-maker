# Issue v0.4.16: `github_fetch`への本文抽出・Markdown変換機能の統合

## 関連イシュー
- `docs/issue/v0.4.15.md`: `http_fetch`ツールに同様の機能を実装した先行イシュー。

## 経緯
`v0.4.15`の実装により、`http_fetch`ツールは`Readability.js`を利用した高精度な本文抽出とMarkdown変換機能を内包するようになりました。これにより、Webソースからの情報取得ワークフローは大幅に簡素化され、生成されるMarkdownの品質も向上しました。

しかし、`github_fetch`ツールは依然としてリポジトリ内のファイルをそのまま取得するだけであり、HTMLファイルが含まれていた場合、後続の`html_to_markdown`ツールによる変換ステップが別途必要となっています。

## 現状の問題点
1.  **ワークフローの不整合と複雑性**: ソースがWebかGitHubかによって、`html_to_markdown`ツールの呼び出し要否をAIエージェントが判断する必要があり、ワークフローに無駄な分岐と複雑性が生じています。
2.  **抽出品質の不統一**: `github_fetch`経由のHTMLファイルは、`html_to_markdown`ツール（`trafilatura`ベース）で処理されるため、`http_fetch`で採用された`Readability.js`ほどの高い抽出精度が期待できません。これにより、ソースによってナレッジベースの品質にばらつきが生じる可能性があります。
3.  **非効率な処理**: `github_fetch`でファイルを取得し、その後`html_to_markdown`で再度ファイルを読み込んで変換するという2段階のプロセスは非効率です。

## 解決策の概要
`github_fetch.py`ツールをリファクタリングし、`http_fetch.py`と同様に、HTMLファイルの本文抽出とMarkdown変換機能をツール内に統合します。

具体的には、取得したファイルがHTMLであった場合に`readability-cli`を呼び出してMarkdownに変換し、それ以外のファイルはそのままコピーするロジックを実装します。これにより、`github_fetch`も自己完結した変換機能を持つようになり、AIエージェントのワークフローを全てのソースで統一・簡素化します。

## 解決策の詳細
1.  **`github_fetch.py` の修正**:
    -   **依存関係チェックの追加**: ツールの実行前に`shutil.which('readable')`を使い、`readability-cli`の存在を確認します。見つからない場合は、`io_utils.eprint_error`で明確なエラーメッセージを出力して終了します。
    -   **処理ロジックの変更**:
        -   リポジトリからファイルをクローンまたはダウンロードした後、各ファイルを処理するループを追加します。
        -   ファイルの拡張子が `.html` または `.htm` の場合:
            -   `subprocess`で`readable-cli`を呼び出し、HTMLファイルパスを渡して本文を抽出・Markdown変換します。
            -   変換後のMarkdownコンテンツを、`--output-dir`に`.md`拡張子で保存します。
            -   `v0.4.15`の`http_fetch.py`に実装された、`BeautifulSoup`による追加のクリーニング処理も同様に適用し、堅牢性を高めます。
        -   上記以外のファイル（`.md`, `.txt`など）の場合:
            -   単純にファイルを`--output-dir`にコピーします。
    -   **標準出力のJSON更新**:
        -   `documents`配列に記録する`path`キーには、最終的に`output-dir`に保存されたファイル名（変換後は`.md`、それ以外は元のファイル名）を記録するようにします。

2.  **`.gemini/commands/rag.md` のワークフロー簡素化**:
    -   `#### B) GitHubソースの場合` のフローを修正します。
    -   「3. 次のステップの判断」の分岐ロジックを完全に削除します。
    -   代わりに、`http_fetch`の場合と同様に、「**ステップ2と3は不要**です。**ステップ4. ドキュメントのエンリッチ** に進んでください。」という指示に統一します。

## 参考とするべきスクリプト等
- src/ragmaker/tools/http_fetch.py

## テスト方法
1.  **`github_fetch.py` の単体テストの拡充**:
    -   **テストリポジトリの準備**: HTMLファイル、Markdownファイル、その他のテキストファイルが混在するローカルのGitリポジトリをテストフィクスチャとして準備します。
    -   **検証項目**:
        -   ツール実行後、出力ディレクトリにHTMLファイルがMarkdownに変換されて保存されていること。
        -   Markdownファイルやテキストファイルは、内容が変更されずにそのままコピーされていること。
        -   標準出力されるJSONの`documents`配列の`path`が、正しく最終的なファイル名を指していること。
        -   `readability-cli`が存在しない場合に、ツールが適切なエラーを出して終了すること。

2.  **`/rag` コマンドの統合テスト**:
    -   HTMLドキュメントを含む実際のGitHubリポジトリを対象に`/rag`コマンドを実行します。
    -   AIエージェントのログを監視し、`github_fetch`の後に`html_to_markdown`が呼び出されることなく、ワークフローが正常に完了することを確認します。


## 実装状況