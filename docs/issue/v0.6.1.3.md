# Issue v0.6.1.3: github_fetch.py のバグ修正とカタログ整合性の確保

## 前提知識
- docs/Architecture/Architecture.md
- discovery.json (マスターツールカタログ)
- src/ragmaker/io_utils.py

## 用語の定義
- **RAGMakerリポジトリルート**: 本プロジェクトのソースコードが置かれているルートディレクトリ。
- **マスターツールカタログ**: `RAGMakerリポジトリルート/discovery.json`。全ツールの定義ファイル。
- **ドキュメントカタログ**: ナレッジベース内にあるドキュメント目録ファイル（catalog.json）。

## 経緯
PR #50 および PR #51 のマージ後、Gemini Code Assist (GCA) のレビューにより、`github_fetch.py` のバグとロジックの複雑性が指摘された。また、アーキテクチャレビューの結果、マスターツールカタログ（`discovery.json`）と各ツールの実装（`argparse`）の間で、引数の必須・任意設定に乖離があることが判明した。これらを修正し、システムの堅牢性と整合性を確保する。

## 現状の問題点
- **github_fetch.py のバグ**: `path_in_repo` に単一ファイルを指定した際、ファイル名と同名のディレクトリを誤作成し、その後のコピーが不安定になる。
- **github_fetch.py の複雑性**: リポジトリ取得ロジックが冗長で保守しにくい。`Repo.clone_from` を用いた簡潔な実装が推奨される。
- **entry_discovery.py のエラー処理不足**: `IOError` が「想定外のエラー」として一括処理されており、詳細な原因がユーザーに伝わらない。
- **カタログと実装の不一致**: `discovery.json` で `required` と定義されている引数が、実装側ではオプション（`required=False`）になっている、あるいはその逆の状態が発生している。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `src/ragmaker/tools/github_fetch.py` のバグが修正され、単一ファイル指定時に不要なディレクトリが作成されない。
- [ ] `src/ragmaker/tools/entry_discovery.py` の `main` 関数で `IOError` が個別にトラップされ、`io_utils.handle_io_error` が呼ばれている。
- [ ] `discovery.json` の各ツール定義（`entry_discovery`, `github_fetch`）の `required` 設定が、実装側の `argparse` と完全に一致している。
- [ ] `pytest` を実行し、新規・既存の全テストがパスしている。

## 解決策の概要
`github_fetch.py` のクローンおよびコピーロジックを GCA の提案に基づき簡素化・修正する。また、`entry_discovery.py` のエラーハンドリングを精密化し、マスターツールカタログと実装のパラメータ定義を同期させる。

## 解決策の詳細
### 1. github_fetch.py の修正
- **クローン処理**: `Repo.clone_from(..., depth=1)` を第一優先とし、失敗時にのみ通常のクローンを実行する。
- **コピー処理**: `source_path.is_file()` を判定し、ファイルの場合は直接 `shutil.copy2` を実行する。先に `mkdir` を行わない。

### 2. entry_discovery.py の修正
- `main` 関数において、`argparse.parse_args()` 等の呼び出しを囲む `try` ブロックに `except IOError as e:` を追加し、`handle_io_error(e)` を実行する。

### 3. マスターツールカタログ (discovery.json) の同期
- `discovery.json` 内の `entry_discovery` において、`title`, `summary`, `src-type` を `required` から除外する（実装側でオプションのため）。
- `github_fetch` の `temp-dir` が実装側で必須であれば、カタログの `required` リストに追加する。
- 実装側の `argparse` においても、カタログで必須とされている項目は `required=True` に設定する。

## 参考とすべきスクリプト等
- `src/ragmaker/io_utils.py` (エラーハンドラ)
- PR #50 / PR #51 の GCA レビューコメント

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `pytest test/test_github_fetch.py` で単一ファイル取得およびディレクトリ取得の両方が正常に動作することを確認した。
- [ ] `pytest test/test_entry_discovery.py` を実行し、アサーションの精度（`stderr` への出力確認など）が向上していることを確認した。
- [ ] 意図的に `IOError` (書き込み権限のない場所への保存など) を発生させ、適切な JSON エラーが出力されることを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] v0.6.1.3 起草
- [ ] `github_fetch.py` のクローン・コピーロジック修正完了
- [ ] `entry_discovery.py` のエラーハンドリング精密化完了
- [ ] `discovery.json` と実装の引数定義同期完了
- [ ] 全テストのパスおよび最終確認完了
