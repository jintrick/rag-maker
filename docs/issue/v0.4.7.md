# Issue v0.4.7

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.toml
- .gemini/commands/ask.toml
- docs/issue/v0.3.4.1.md (Windows環境での標準出力エンコーディング問題)

## 経緯
v0.4.0のアーキテクチャ変更により、ナレッジベースはユーザーが指定した任意の外部ディレクトリに作成される「自己完結型」の単位となりました。
しかし、この変更は予期せぬ重大な副作用をもたらしました。AIエージェント（Gemini CLI）はセキュリティ上の制約から、自身の実行環境（プロジェクトディレクトリ）の外部にあるファイルシステムへの直接的な読み取りアクセスが許可されていません。

`/rag`コマンドのワークフローでは、AIエージェントがキャッシュ内の全ドキュメントを読み込み、その内容を俯瞰してナレッジベース全体の`title`と`summary`を生成するという重要なステップが存在します。現在のアーキテクチャでは、このステップが実行不可能になっています。

## 現状の問題点
AIエージェントが、外部に作成されたナレッジベースのキャッシュディレクトリ（`<KB_ROOT>/cache/`）内にあるMarkdownファイルの内容を読み取ることができません。
これにより、`/rag`コマンドの最終段階である「ナレッジベースの全体像を要約」タスクを遂行できず、ワークフローが事実上停止してしまいます。エージェントはファイルを読むためのツールを持っておらず、自力でこの問題を解決することができません。

## 解決策の概要
指定されたファイルのパスを受け取り、その内容を読み込んで標準出力（stdout）に書き出す、シンプルな新しいツール `read_file` を実装します。
そして、`/rag` コマンドのワークフローを修正し、AIエージェントがファイル内容を読み込む必要がある場面で、この `read_file` ツールを使用するように明確に指示します。

## 解決策の詳細
1.  **`read_file.py` ツールの新規作成**:
    -   `src/ragmaker/tools/` ディレクトリに `read_file.py` を作成します。
    -   **引数**: `--path`（読み込むファイルのパス）を必須引数として受け取ります。
    -   **機能**: 指定されたパスのファイルをUTF-8エンコーディングで読み込みます。
    -   **出力**: `src/ragmaker/io_utils.py` の `print_json_stdout` 関数を呼び出して、以下の構造を持つJSONオブジェクトを標準出力に書き出します。これにより、出力の一貫性を保ち、将来的なメタ情報の追加にも対応できます。
        ```json
        {
          "status": "success",
          "path": "読み込んだファイルのパス",
          "content": "読み込んだファイルの内容（文字列）"
        }
        ```
    -   **エラーハンドリング**: ファイルが存在しない場合や読み込みエラーが発生した場合は、`src/ragmaker/io_utils.py` の `eprint_json_stderr` 関数を使用して、構造化されたエラー情報を標準エラー出力に書き出し、非ゼロの終了コードで終了します。

2.  **`discovery.json` への登録**:
    -   作成した `read_file` ツールを、プロジェクトルートの `discovery.json` に登録します。コマンド名は `ragmaker-read-file` とします。

3.  **`.gemini/commands/rag.md` のワークフロー修正**:
    -   「### 2. 後処理とメタデータ登録」の「ナレッジベースの全体像を要約」ステップを具体的に修正します。
        1.  まず、`read_file` ツールを `--path {{kb_root}}/cache/discovery.json` という引数で実行し、ドキュメントカタログの内容を読み込みます。
        2.  読み込んだJSONデータから `documents` 配列を取得し、各要素の `path` キーを抽出して、要約対象となるMarkdownファイルパスのリストを作成します。
        3.  そのリストをループ処理し、各ファイルパスに対して `read_file` ツールを再度呼び出して、すべてのファイルの内容を取得します。
        4.  各ツールから返されたJSON出力の `content` フィールドをすべて連結し、それを基にナレッジベース全体を表す**単一の** `title` と `summary` をあなたの推論能力で生成します。
        5.  最後に、`entry_discovery` ツールを呼び出します。`--kb-root` に `{{kb_root}}` を、`--title` と `--summary` には今あなたが生成したものを、`--source-url` と `--src-type` にはワークフローの初期段階で与えられた情報を指定してください。

## 参考とすべきスクリプト等
-   `src/ragmaker/tools/` (新しいツールの配置場所)
-   `src/ragmaker/io_utils.py` (エラー出力に利用する共通ユーティリティ)
-   `discovery.json` (プロジェクトルートのツールカタログ)
-   `.gemini/commands/rag.md` (ワークフローの修正対象)

## テスト方法
**注意:** 新しいツール (`read_file`) を追加するため、テストを実行する前に `pip install -e .[test]` を実行して、コマンドをシステムに登録し直す必要があります。

1.  **`read_file.py` の単体テスト**:
    -   `test/test_read_file.py` を新規作成します。
    -   テスト用のファイルを作成し、`read_file` ツールが `status`, `path`, `content` を含む正しい構造のJSONを標準出力に書き出すことを確認します。
    -   `cache/discovery.json` のようなJSONファイルも正しく読み込めることを確認します。
    -   存在しないファイルを指定した場合に、エラーが正しく処理されることを確認します。
2.  **`/rag` コマンドの統合テスト**:
    -   `/rag` コマンドのワークフローを最後まで実行します。
    -   AIエージェントが、要約生成のステップで `read_file` ツールを複数回呼び出し、最終的に `entry_discovery` ツールに適切な `title` と `summary` を渡して実行することを確認します。

## 実装状況
