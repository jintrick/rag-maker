# Issue v0.4.8: `enrich_discovery` ツールへのバッチ更新機能の導入

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.md
- docs/issue/v0.4.7.md (read_fileツールの導入経緯)

## 経緯
v0.4.7で、AIエージェントが外部ファイルのファイルシステムにアクセスするための `read_file` ツールを導入しました。これにより、ドキュメントのエンリッチ処理（各ドキュメントの要約生成）や、ナレッジベース全体の要約生成が可能になりました。

しかし、エンリッチ処理のワークフローを完成させるには、もう一つ重要な機能が欠けていることが判明しました。

## 現状の問題点
AIエージェントは `read_file` ツールでドキュメントを読み、エンリッチ情報（title, summary）をメモリ上で生成できますが、その結果をファイルに書き戻す効率的な手段が存在しません。
ドキュメントごとにファイル書き込みを行うと、ドキュメント数が多い場合に著しいパフォーマンス低下を招くため、一括で更新処理を行えるツールが必要です。

## 解決策の概要
`enrich_discovery` ツールを、複数のドキュメント情報を一度の呼び出しでまとめて更新できる「バッチ更新」方式に変更します。

AIエージェントは、各ドキュメントのエンリッチ情報をメモリ上に蓄積し、最後に一度だけ `enrich_discovery` ツールを呼び出すことで、処理を完了させます。

## 解決策の詳細
1.  **`enrich_discovery.py` ツールの新規作成**:
    -   `src/ragmaker/tools/` ディレクトリに `enrich_discovery.py` を作成します。
    -   **引数**:
        -   `--discovery-path`: 変更対象の `discovery.json` ファイルのフルパス。
        -   `--updates`: 更新内容を含むJSON文字列。このJSONは、`path`, `title`, `summary` をキーに持つオブジェクトの配列である必要があります。
            -   例: `'[{"path": "page_0.md", "title": "Title A", "summary": "Summary A"}, {"path": "page_1.md", "title": "Title B", "summary": "Summary B"}]'`
    -   **機能**:
        1.  `--discovery-path` で指定されたJSONファイルを読み込み、パースします。
        2.  `--updates` で渡されたJSON文字列をパースし、更新オブジェクトの配列を取得します。
        3.  読み込んだ `discovery.json` の `documents` 配列を効率的に検索できるよう、`path` をキーとする辞書に変換しておくと良いでしょう。
        4.  更新オブジェクトの配列をループし、各オブジェクトの `path` を使って対象のドキュメントエントリを特定し、`title` と `summary` を更新します。
        5.  すべての更新が完了したら、変更後のJSONオブジェクト全体を元のファイルにUTF-8で上書き保存します。
    -   **出力**: 成功した場合は、変更が適用されたことを示すJSONを標準出力に書き出します。
    -   **エラーハンドリング**: 対象ファイルが見つからない、JSONとして不正、`--updates` の形式が不正、更新対象エントリが見つからない等の場合は、構造化されたエラー情報を標準エラー出力に書き出します。

2.  **`discovery.json` への登録**:
    -   作成した `enrich_discovery` ツールを、プロジェクトルートの `discovery.json` に登録します。コマンド名は `ragmaker-enrich-discovery` とします。

3.  **`.gemini/commands/rag.md` のワークフロー修正**:
    -   「### 4. ドキュメントのエンリッチ」ステップを修正します。
    -   AIエージェントのワークフローを以下のように変更します。
        1.  更新内容を格納するための空のリストをメモリ上に準備する。
        2.  `documents` 配列をループ処理する。
        3.  ループ内で、各ドキュメントの `title` と `summary` を生成する。
        4.  生成した `path`, `title`, `summary` を持つオブジェクトを作成し、メモリ上のリストに追加する。
        5.  **ループが完了した後**、メモリ上のリストをJSON文字列に変換する。
        6.  `enrich_discovery` ツールを**一度だけ**呼び出し、`--discovery-path` と `--updates` 引数にそれぞれファイルパスと生成したJSON文字列を渡す。

## 参考とすべきスクリプト等
-   `src/ragmaker/tools/` (新しいツールの配置場所)
-   `src/ragmaker/io_utils.py` (エラー出力に利用する共通ユーティリティ)
-   `discovery.json` (プロジェクトルートのツールカタログ)
-   `.gemini/commands/rag.md` (ワークフローの修正対象)

## テスト方法
**注意:** 新しいツール (`enrich_discovery`) を追加するため、テストを実行する前に `pip install -e .[test]` を実行して、コマンドをシステムに登録し直す必要があります。

1.  **`enrich_discovery.py` の単体テスト**:
    -   `test/test_enrich_discovery.py` を新規作成します。
    -   テスト用の `discovery.json` を準備し、`enrich_discovery` ツールが指定されたエントリの `title` と `summary` だけを正しく更新することを確認します。
    -   他のエントリやJSON構造が変更されていないことを確認します。
    -   対象の `path` が存在しない場合に、エラーが正しく返されることを確認します。
2.  **`/rag` コマンドの統合テスト**:
    -   `/rag` コマンドのワークフローを最後まで実行します。
    -   AIエージェントが、エンリッチ処理のループ内で `read_file` と `enrich_discovery` を適切に呼び出し、最終的に `cache/discovery.json` のすべてのエントリに `title` と `summary` が追記されていることを確認します。

## 実装状況
