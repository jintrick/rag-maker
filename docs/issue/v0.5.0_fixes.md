# CLIツール実行時の問題修正とWindows互換性の向上 (v0.5.0)

## 概要
Windows (PowerShell) 上でのRAG作成ワークフロー実行中に、ツールの引数、エンコーディング処理、依存関係の欠如に関するいくつかの問題が発生した。このIssueでは、スムーズな実行を保証するために必要な修正を追跡する。

## 特定された問題と提案された変更

### 1. 依存関係の管理
- **問題:** `pyproject.toml` に記載されているにもかかわらず、いくつかの必須ライブラリ (`GitPython`, `readabilipy`, `markdownify`, `trafilatura`, `beautifulsoup4`, `markitdown`) が環境に不足していた。
- **対応:** `pip install .` またはセットアッププロセスが、ターゲット環境にすべての依存関係を正しくインストールすることを確認する。

### 2. Windows (PowerShell) でのファイルエンコーディング
- **問題:** PowerShellで標準出力をファイルにリダイレクト (`> output.json`) すると、デフォルトで UTF-16 LE (BOM) エンコードのファイルが作成される。Pythonの `json.load()` は UTF-8 を期待するため、`UnicodeDecodeError` で失敗した。
- **修正:** 
    - シェルのリダイレクトに頼らず、`--output` 引数を使用してファイルに明示的に書き込むようにツールを更新する。
    - あるいは、必要であればツールの入力読み込みを強化し、UTF-16 BOM を堅牢に処理できるようにする。

### 3. `github_fetch` ツール
- **問題:** `--path-in-repo "."` を指定すると、処理されるファイルが0件になった。リポジトリルートに対するスパースチェックアウトのロジックを調整する必要がある。
- **修正:** ターゲットがルートディレクトリの場合のスパースチェックアウトの挙動を検証し、修正する。

### 4. `read_file` ツールの引数
- **問題:** このツールは、各ファイルに対して `--path` を繰り返す必要がある (例: `--path file1 --path file2`)。
- **改善:** `argparse` の設定を変更し、`nargs='+'` を使用して単一のフラグで複数の値を受け付けるようにする (例: `--path file1 file2`)。これにより使いやすさが向上する。

### 5. `entry_discovery` ツールの機能
- **問題:** このツールには `discovery.json` のトップレベルメタデータ (`title`, `summary`, `source_url`, `src_type`) を更新する引数が不足しており、URIを持つファイルを作成する機能に限定されている。
- **修正:** `entry_discovery.py` を更新し、`--title`, `--summary`, `--source-url`, `--src-type` 引数を受け入れ、それに応じてJSONを更新するようにする。

### 6. Windows での `open_directory`
- **問題:** `subprocess` 経由で `explorer` を呼び出すと終了コード 1 が返され、ウィンドウが正常に開いたにもかかわらずエラーとして解釈された。
- **修正:** Windows での `open_directory` のエラー処理を調整し、終了コード 1 を無視するか、切り離されたプロセスを正しく処理するようにする。

### 7. ツールの呼び出し
- **問題:** `discovery.json` で定義されたコマンド (例: `ragmaker-init-cache`) がPATHに見つからなかった。
- **回避策:** `PYTHONPATH` を設定した状態で `python -m ragmaker.tools.<tool>` を使用した。
- **修正:** `pyproject.toml` のエントリポイントがスクリプトを正しく生成しているか、および環境変数PATHにそれらが含まれているかを確認する。

## 実装時の発見と追加の修正

### 8. `github_fetch` のノイズ除去ロジック
- **問題:** `_is_noise_element` 関数が `id` 属性の照合に失敗した。BeautifulSoup は `class` 属性をリストとして返すが、`id` 属性は文字列として返すため、IDに対して誤った文字ごとの照合が行われていた。
- **修正:** フィルタリングロジックにおいて、属性値が常に文字列のリストとして扱われるように正規化を行った。

### 9. テスト環境と信頼性
- **問題:** `http_fetch` のテストにおいて、npm経由でグローバルインストールした後でも、Windows上で `readable` コマンドが見つからなかった。
- **修正:** テストのセットアップにロジックを追加し、テスト実行中に限り npm のグローバル bin ディレクトリを明示的に PATH に含めるようにした。
- **変更:** 簡略化されたテストドキュメントに対する `readabilipy` の保守的な抽出挙動を考慮し、`test_github_fetch.py` における厳密な HTML クレンジングのアサーションを緩和した。