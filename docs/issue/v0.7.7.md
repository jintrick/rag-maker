# Issue v0.7.7

## 前提知識
- src/ragmaker/tools/ask_dir.py
- Windows API `IFileOpenDialog` 仕様：
  - 単一選択時：`GetResult()` (IShellItem) を使用。
  - 複数選択時（`FOS_ALLOWMULTISELECT` 指定時）：`GetResults()` (IShellItemArray) を使用。

## 経緯
v0.7.6 までの実装では、単一選択か複数選択かに関わらず常に `GetResults()` を呼び出していた。Windows API の仕様により、単一選択モードで `GetResults()` を呼び出すとエラーになるため、通常使用（単一ディレクトリ選択）すら壊れている状態である。この不整合を修正する。

## 現状の問題点
- **単一選択の崩壊**: `--multiple` を指定せずにディレクトリを選択しても、`GetResults()` の呼び出しが失敗するため、結果が返らずキャンセル扱い（または COM エラー）になる。
- **API 違反**: `FOS_ALLOWMULTISELECT` フラグの状態と、結果取得メソッド（`GetResult` vs `GetResults`）が正しく対応していない。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `src/ragmaker/tools/ask_dir.py` において、`multiple` フラグの状態に応じて `GetResult()` と `GetResults()` が正しく使い分けられている。
- [x] `--multiple` なし（単一選択）の場合に、正しくディレクトリパスが取得され、`selected_directory` として出力される。
- [x] `--multiple` あり（複数選択）の場合に、`IShellItemArray` から全てのパスが取得され、`selected_directories` として出力される。
- [x] Windows 以外の OS における `tkinter` フォールバックが引き続き正常に動作し、`multiple` フラグに応じた型で結果を返す。
- [x] プロジェクト全体の pytest を実行し、全てのテストがパスしている。

## 解決策の概要
`multiple` フラグを条件分岐のトリガーとし、単一選択時は `dialog.GetResult()` を、複数選択時は `dialog.GetResults()` を呼び出すようにロジックを修正する。

## 解決策の詳細
- `src/ragmaker/tools/ask_dir.py` の `_ask_directory_windows` 関数を修正：
  - `multiple` が真なら `dialog.GetResults()` を呼び出し、ループでパスを抽出。
  - `multiple` が偽なら `dialog.GetResult()` を呼び出し、単一のパスを抽出。
- 各々のメソッドが失敗した場合のエラーハンドリング（`pythoncom.com_error`）を適切に行う。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/ask_dir.py` (v0.7.6 時点の実装)

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] Windows 環境で `ragmaker-ask-dir`（フラグなし）を実行し、1つのフォルダが正しく選択・出力されることを確認した。
- [x] `test/test_ask_dir.py` のモックを更新し、`GetResult` と `GetResults` の呼び出しが正しく分岐していることを検証した。
- [x] `pytest` を実行し、全テストのパスを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] Fixed: Windows directory selection logic (split GetResult/GetResults).
