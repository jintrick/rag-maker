# Issue v0.6.1.9: パッケージ依存関係テストの堅牢化とリファクタリング

## 前提知識
- docs/issue/v0.6.1.8.md
- test/test_package_dependency.py
- PR #57 における Gemini Code Assist (GCA) のレビュー指摘事項

## 経緯
Issue v0.6.1.8 で導入された `test/test_package_dependency.py` に対し、GCA より「コード重複の多さ」と「検証方法の脆弱性」が指摘された。また、一部の環境で依存関係の隔離が不十分であり、テストが期待通りに動作しない問題が確認された。これらを改善し、信頼性の高いテスト基盤を確立する。

## 現状の問題点
- **コードの重複**: 複数のツール（file_sync, install_kb, init_cache）に対してほぼ同一のテストロジックが記述されており、保守性が低い。
- **検証の脆弱性**: 期待されるエラーを単なる文字列検索（`assertIn`）で確認している。ツールの出力は構造化 JSON であるため、本来はパースして検証すべきである。
- **環境隔離の不備**: `PYTHONPATH` を削除するだけでは、実行環境によっては暗黙的にパッケージがロードされ、`ImportError` が発生しない（テストが偽陰性となる）場合がある。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `test/test_package_dependency.py` が `subTest` を使用したパラメタライズドテストにリファクタリングされ、コード重複が排除されている。
- [x] ツールからのエラー出力を `json.loads()` でパースし、ステータスやメッセージの内容を構造的に検証している。
- [x] テスト環境の隔離ロジックが強化（例：一時ディレクトリへのスクリプト退避実行など）され、確実に `ImportError` を誘発できることが実証されている。
- [x] `pytest` を実行し、全テストケースがパスしている。

## 解決策の概要
テストコードを洗練させ、重複を排除すると同時に、構造化データとしての検証を導入する。また、OSや環境に左右されず確実に「パッケージ未インストール状態」を再現できる強力な隔離環境下でのテスト実行を実現する。

## 解決策の詳細
### 1. パラメタライズドテストの導入
GCA の提案に基づき、テストケースを辞書形式で定義し、単一のテストメソッド内で `subTest` を用いて回す実装に改める。

### 2. JSON パースによる検証
`result.stderr` をパースし、`status == "error"` およびメッセージ内に期待する文言が含まれていることを確認する。

### 3. 強固な環境隔離
単に環境変数を操作するのではなく、テスト対象のスクリプトを `TemporaryDirectory` 等の「`ragmaker` パッケージが物理的に存在しない場所」へ一時的にコピーして実行し、確実に `ImportError` を発生させるロジックを検討・実装する。

## 参考とすべきスクリプト等
- PR #57 の GCA レビューコメント（`subTest` および JSON 検証のコード例）

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `pytest test/test_package_dependency.py` を実行し、パラメタライズされた各ツール（3種）のテストがすべてパスすることを確認した。
- [x] 意図的に隔離ロジックを無効化した場合にテストが失敗することを確認し、テスト自体の妥当性を検証した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] v0.6.1.9 起草
- [x] `test_package_dependency.py` のリファクタリング完了
- [x] JSON パースによる厳格な検証の実装完了
- [x] 環境隔離ロジックの強化完了
- [x] 最終パス確認完了
