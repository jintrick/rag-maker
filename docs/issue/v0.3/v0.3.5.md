# Issue v0.3.5

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.toml
- .gemini/commands/ask.toml

## 経緯

## 現状の問題点
- `cache`ディレクトリにソースが残ってしまう。ソースはもう使わないので、マークダウンだけにしないとリソースの無駄である。
- 文書を更新する必要があるが、現在のdiscovery.jsonではソースが分からない。

## 解決策の概要

1.  **キャッシュクリーンアップ機能の導入**: `/rag` コマンドのワークフローに、Markdown生成後に不要となったソースファイル（HTML、クローンしたリポジトリなど）を削除する機能を追加します。これにより、キャッシュディレクトリのストレージ使用量を最適化します。

2.  **`discovery.json` スキーマの拡張**: 各ドキュメントセットのルートに配置される `discovery.json` に、ソース情報を集約するトップレベルのプロパティ（例: `source_info`）を新設します。このプロパティには、ソースのURL、種類（`web`, `github`など）、最終取得日時などを記録し、将来のドキュメント更新処理に備えます。


## 解決策の詳細

この解決策は、2つの主要な変更から構成されます。

### 1. `html_to_markdown.py` の修正

Webソースから取得したドキュメントを処理する `html_to_markdown.py` ツールを修正します。

-   **機能**: Markdownへの変換後、キャッシュディレクトリ内の `discovery.json` を更新する際に、不要となった元の `html_path` キーをエントリに含めないようにします。
-   **目的**: カタログ情報が生成される時点でスリム化し、後続の処理で不要なデータを扱う必要をなくします。

### 2. キャッシュクリーンアップツールの導入 (`cache_cleanup.py`)

`/rag` コマンドのワークフローの最後に実行される新しいツール `cache_cleanup.py` を `tools/` ディレクトリに作成します。

-   **機能**: 指定されたキャッシュディレクトリ（例: `.cache/xxxxxxxx/`）を受け取り、そのディレクトリ内に存在するファイルのうち、Markdownファイル (`.md`) と `discovery.json` **以外**のすべてのファイルおよびディレクトリを物理的に削除します。
-   **目的**: `http_fetch` や `git clone` によって生成された元ソースファイル（HTML、リポジトリ全体など）を削除し、RAGに必要なMarkdownファイルのみを残すことで、ストレージ使用量を削減します。
-   **インターフェース**: 他のツールと同様に、コマンドライン引数 (`--target-dir`) を受け取り、処理結果をJSON形式で標準出力します。

### 3. `discovery.json` スキーマ拡張と `entry_discovery` ツールの改修

ナレッジベースの更新機能を将来的に実装するため、ソース情報を永続化します。

-   **スキーマ拡張**: RAGMakerのルートに配置される `discovery.json` 内の `documents` 配列の各エントリオブジェクトに、`source_info` という新しいキーを追加します。
    -   `source_info` オブジェクトは以下のキーを持ちます。
        -   `url`: ソースの元となったURLまたはパス (例: `https://example.com`, `https://github.com/user/repo.git`, `./local/docs`)。
        -   `fetched_at`: ソースを取得した日時（ISO 8601形式）。
-   **`entry_discovery.py` の改修**:
    -   コマンドライン引数に `--source-url` を追加します。
    -   `entry_discovery` 関数は、この `--source-url` と現在時刻から `source_info` オブジェクトを生成し、`discovery.json` に書き込むエントリに含めます。
-   **影響**: この変更により、`/rag` コマンドは `entry_discovery` を呼び出す際に、元のソースURLを渡す必要があります。また、この情報を利用して、将来的に特定のナレッジベースを再取得・更新する機能（例: `/rag --update <path>`）の実装が可能になります。

## 参考とすべきスクリプト等

- `tools/html_to_markdown.py`
- `tools/entry_discovery.py`
- `test/test_entry_discovery.py`

## テスト方法

Julesへ。

以下の手順で、今回改修・作成した各ツールのテストを実施してください。テスト関連のファイルはすべて `test/` ディレクトリに作成・配置してください。

### 1. `entry_discovery.py` のテスト

`--source-url` 引数を受け取り、`source_info` を正しくルートの `discovery.json` に追加・更新できることを確認します。

-   **テストファイル**: `test/test_entry_discovery.py` (既存のファイルを更新して使用)
-   **実行コマンド**: `python -m unittest test/test_entry_discovery.py`
-   **確認事項**: 新規追加時、および既存エントリ更新時の両方で、`source_info` オブジェクトが正しく書き込まれることを `unittest.TestCase` でアサートして検証します。

### 2. `html_to_markdown.py` のテスト

キャッシュディレクトリ内の `discovery.json` 更新時に、不要な `html_path` キーを削除する機能を確認します。

-   **テストファイル**: `test/test_html_to_markdown.py` (新規作成)
-   **実行コマンド**: `python -m unittest test/test_html_to_markdown.py`
-   **確認事項**: `html_path` を含むテスト用の `discovery.json` を用意し、ツール実行後にそのキーが削除されていることを `json` モジュールで読み込んで検証します。

### 3. `cache_cleanup.py` のテスト

キャッシュディレクトリ内の不要なファイルを正しく物理削除できることを確認します。

-   **テストファイル**: `test/test_cache_cleanup.py` (新規作成)
-   **実行コマンド**: `python -m unittest test/test_cache_cleanup.py`
-   **確認事項**: テスト用のディレクトリに `.md` ファイル、`discovery.json`、および削除対象のファイル（`.html`, `.txt` など）とサブディレクトリを配置します。ツール実行後、`.md` ファイルと `discovery.json` のみが残り、他がすべて削除されていることを `os` モジュールや `pathlib` を使って検証します。

## 実装状況
This commit introduces a significant refactoring of the `/rag` command's workflow to improve efficiency and maintainability.

The key changes are:

1.  **`html_to_markdown.py` Refactoring**: The script is now driven by the `discovery.json` file within a cache directory. It operates in-place, converting specified HTML files to Markdown, deleting the original HTML source, and updating the `discovery.json` by removing the `html_path` key. This simplifies the workflow and makes the tool's function more explicit.

2.  **New `cache_cleanup.py` Tool**: A new tool has been added to physically remove all files and directories from a cache directory except for the essential `.md` files and `discovery.json`. This reduces storage usage by cleaning up intermediate files like images or scripts that are not needed for RAG.

3.  **`entry_discovery.py` Enhancement**: The script now requires a `--source-url` argument to persist the original source of the document set. This information is stored in a `source_info` object in the root `discovery.json`, enabling future features like updating knowledge bases.

4.  **Workflow Update**: The `.gemini/commands/rag.md` prompt has been updated to orchestrate these new and modified tools in the correct sequence.

5.  **Testing**: Comprehensive unit tests have been added for `cache_cleanup.py` and the refactored `html_to_markdown.py`. The tests for `entry_discovery.py` have been updated to reflect its new requirements.
