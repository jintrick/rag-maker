# Issue v0.3.4.1

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.md

## 経緯
Jules Google DocsをRAGシステムに登録する際、`entry_discovery` ツールを使用したが、以下の問題に直面し、複数回失敗した。

1.  **引数の誤解:**
    `rag.md` の指示に基づき、`entry_discovery.py` に `--title` と `--summary` 引数を渡そうとしたが、ツールがこれらの引数を認識せずエラーとなった。`entry_discovery.py` は、キャッシュディレクトリ内の `discovery.json` からこれらの情報を読み込む設計であった。

2.  **`discovery.json` のJSON構文破損:**
    `cache/jules.google/discovery.json` の `summary` フィールドをLLMの要約で更新する際に、`replace` ツールの厳密な文字列一致要件を理解しきれておらず、JSONの構文（特にカンマの有無）を破損させてしまった。これにより、`entry_discovery.py` が `discovery.json` を読み込めなくなり、「Expecting ',' delimiter」や「Expecting property name enclosed in double quotes」といったエラーが発生した。

3.  **`UnicodeEncodeError`:**
    `entry_discovery.py` の実行中に `UnicodeEncodeError: 'cp932' codec can't encode character '\u2014'` が発生した。これは、Windows環境のデフォルトエンコーディング（cp932）が、要約に含まれる特定のUnicode文字（em dash '—' など）を処理できないために発生した。
    *   当初、`json.dump` に `encoding='utf-8'` を追加することで解決を試みたが、これは `json.dump` の引数としては不適切であり、`JSONEncoder.__init__() got an unexpected keyword argument 'encoding'` エラーを引き起こした。
    *   次に、`json.dumps` で文字列を生成し、それを `f.write()` でファイルに書き込む方法を試みたが、`sys.stderr` や `sys.stdout` への出力エンコーディングの問題が残った。
    *   最終的に、`eprint_error` 関数内で `sys.stderr.buffer.write()` を使用し、明示的にUTF-8バイト列を書き込むことで、このエンコーディング問題を回避した。

これらの問題を解決するために、`cache/jules.google/discovery.json` のJSON構文を複数回手動で修正し、`entry_discovery.py` のエンコーディングに関する出力処理を修正した。最終的に、`discovery.json` のJSON構文が完全に修正されたことで、`entry_discovery` ツールは正常に動作し、Jules Google DocsのRAGシステムへの登録が完了した。

## 現状の問題点
- `entry_discovery.py` の現在の実装では、`title` と `summary` をキャッシュディレクトリ内の `discovery.json` から読み込む仕様になっている。
- しかし、本来のワークフローでは、AIエージェントが自身の推論能力を用いて `title` と `summary` を生成し、それらを `entry_discovery` ツールに引数として渡すことが期待されている。
- この仕様の不一致が、`rag.md` の指示とツールの実際の動作との乖離を生み、エージェントの作業を複雑にしている。

## 解決策の概要
`entry_discovery.py` ツールを修正し、`--title` と `--summary` をコマンドライン引数として直接受け取るように変更する。これにより、AIエージェントが推論したタイトルと要約を直接ツールに渡せるようにし、`rag.md` の指示とツールの実際の動作との整合性を図る。

## 解決策の詳細
1.  **`entry_discovery.py` の引数変更:**
    *   `argparse` の定義において、`--title` と `--summary` を必須のコマンドライン引数として追加する。
    *   `--path` 引数は引き続きキャッシュディレクトリのパスとして使用する。
    *   `--src-type` 引数も引き続き使用する。
2.  **キャッシュからの読み込みロジックの削除:**
    *   `get_metadata_from_cache` 関数を削除する。
    *   `main` 関数内で `get_metadata_from_cache` を呼び出している箇所を削除する。
3.  **新しいエントリの作成ロジックの変更:**
    *   `new_document_entry` を作成する際に、`metadata["title"]` や `metadata["summary"]` ではなく、直接 `args.title` と `args.summary` を使用するように変更する。
    *   これにより、`entry_discovery.py` はキャッシュディレクトリ内の `discovery.json` からタイトルと要約を読み込む必要がなくなる。

## 参考とすべきスクリプト等
*   `tools/entry_discovery.py`: 修正対象となる主要なスクリプト。
*   `.gemini/commands/rag.md`: `entry_discovery` ツールの呼び出しに関する記述が含まれており、ツールの修正後にこのドキュメントも更新する必要があるため。

## テスト方法
1.  **テスト用キャッシュディレクトリの準備:**
    *   一時的なキャッシュディレクトリ（例: `.tmp/test_cache/`）を作成する。
    *   このディレクトリ内に、`discovery.json` ファイルを配置する。この `discovery.json` には、`title` と `summary` が含まれていてもいなくても構いません（ツールがこれらを読み込まないことを確認するため）。
2.  **`entry_discovery.py` の実行:**
    *   修正後の `entry_discovery.py` を、新しい引数 `--title` と `--summary` を含めて実行する。
    *   例: `python tools/entry_discovery.py --path .tmp/test_cache/ --src-type test --title "テストタイトル" --summary "テスト要約"`
3.  **ルート `discovery.json` の確認:**
    *   プロジェクトルートの `discovery.json` を開き、実行時に指定した `--title` と `--summary` が正しく反映された新しいエントリが追加または更新されていることを確認する。
    *   また、`entry_discovery.py` がキャッシュディレクトリ内の `discovery.json` からタイトルや要約を読み込もうとしていないことを、実行ログやエラーメッセージから確認する（もしエラーが発生すれば、それは読み込みを試みている証拠となる）。
