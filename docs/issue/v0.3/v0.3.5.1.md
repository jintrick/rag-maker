# Issue v0.3.5.1

## 前提知識
*   `docs/issue/v0.3.5.md`: v0.3.5での`/rag`コマンドのワークフロー変更に関するドキュメント。
*   `.gemini/commands/rag.md`: `/rag`コマンドの現在のワークフロー定義。
*   `discovery.json`: システム全体のドキュメントとツールの定義ファイル。

## 経緯
v0.3.5の改修で`/rag`コマンドのワークフローがリファクタリングされました。この変更には、`html_to_markdown`ツールの引数変更（`--input-dir`, `--output-dir` -> `--target-dir`）や、`entry_discovery`ツールへの`--source-url`引数の追加が含まれていました。
しかし、これらのツールの仕様変更が、ルートにある`discovery.json`のツール定義に正しく反映されていませんでした。
さらに、手動でのマージミスにより、`discovery.json`ファイル自体のJSON構造が壊れていることが判明しました。

## 現状の問題点
1.  **`discovery.json`のJSON構造が不正**: `documents`配列と`tools`配列がファイル内に2重に定義されており、JSONとして無効な状態です。これにより、ファイルのパース時にエラーが発生します。
2.  **`html_to_markdown`ツールの定義が古い**: `discovery.json`内の`html_to_markdown`ツールの定義が、古い引数（`--input-dir`, `--output-dir`）のままになっています。実際のスクリプト (`tools/html_to_markdown.py`) とワークフロー (`.gemini/commands/rag.md`) は新しい`--target-dir`引数を期待しているため、不整合が生じています。
3.  **`entry_discovery`ツールの定義が不完全**: `discovery.json`内の`entry_discovery`ツールの定義に、必須引数である`--source-url`が欠けています。ワークフローは`--source-url`を指定してツールを呼び出すため、このままではツール実行時に引数エラーが発生します。

## 解決策の概要
`discovery.json`ファイルを修正し、v0.3.5の実装内容と完全に一致させます。具体的には、JSON構造を修復し、`html_to_markdown`と`entry_discovery`ツールのパラメータ定義を現在の仕様に更新します。

## 解決策の詳細
1.  **JSON構造の修復**: `c:\Synology Drive\2way-sync\work\rag-maker\discovery.json` を開き、重複している`documents`配列と`tools`配列を削除し、単一のルートオブジェクトを持つ有効なJSON形式に修正してください。
2.  **`html_to_markdown`ツールの更新**:
    *   `discovery.json`内の`tools`配列から`html_to_markdown`オブジェクトを探します。
    *   `parameters.properties`から`input-dir`と`output-dir`を削除します。
    *   代わりに`target-dir`プロパティを追加します。descriptionは「HTMLファイルが含まれ、Markdownファイルがインプレースで作成される対象ディレクトリ。」とします。
    *   `parameters.required`配列を`["target-dir"]`に更新します。
3.  **`entry_discovery`ツールの更新**:
    *   `discovery.json`内の`tools`配列から`entry_discovery`オブジェクトを探します。
    *   `parameters.properties`に`source-url`プロパティを追加します。descriptionは「ドキュメントの元のソースURLまたはパス。」とします。
    *   `parameters.required`配列に`"source-url"`を追加します。

## 参考とすべきスクリプト等
*   `c:\Synology Drive\2way-sync\work\rag-maker\discovery.json` (修正対象ファイル)
*   `c:\Synology Drive\2way-sync\work\rag-maker\.gemini\commands\rag.md` (ツールの正しい呼び出し方を示している)
*   `c:\Synology Drive\2way-sync\work\rag-maker\tools\html_to_markdown.py` (実装されている引数を確認できる)
*   `c:\Synology Drive\2way-sync\work\rag-maker\tools\entry_discovery.py` (実装されている引数を確認できる)

## テスト方法
1.  修正後、`/rag https://...` のようにWebページのURLを指定してRAGコマンドを実行します。
2.  エージェントがエラーなくワークフローを最後まで実行できることを確認します。
3.  特に、`html_to_markdown`が`--target-dir`付きで、`entry_discovery`が`--source-url`付きで呼び出されることを確認します。
4.  最終的に、ルートの`discovery.json`に新しいドキュメントエントリが正しく追加されることを確認します。

## 実装状況