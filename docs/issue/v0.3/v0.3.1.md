# Issue v0.3.1: `/rag`コマンドにおける未実装ツールの実装

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.toml

## 現状の問題点
`/rag`コマンドにおいて、RAGMakerシステムへの登録機能（`entry_discovery`ツール）が未実装であるため、`/rag`コマンドの全機能が利用できない。

## 解決策の概要
`entry_discovery`ツールを実装し、`/rag`コマンドのシステム登録機能を完成させる。

## 解決策の詳細

### `tools/entry_discovery.py` の実装

以下のPythonスクリプトを `tools/entry_discovery.py` として作成します。このスクリプトは、`discovery.json` ファイルを安全に読み込み、新しいドキュメントエントリの追加または既存エントリの更新を行います。

```python
#!/usr/bin/env python3
# -*- coding: utf-8 -*-
"""
このツールは、RAGMakerルートの`discovery.json`に新しいドキュメントエントリを追加または更新します。
"""

import json
import os
import argparse
import sys

def entry_discovery(path: str, title: str, summary: str, src_type: str, discovery_path: str = 'discovery.json'):
    """
    discovery.jsonにエントリを追加または更新します。

    Args:
        path (str): 登録するキャッシュディレクトリのパス。
        title (str): 登録するドキュメントのタイトル。
        summary (str): 登録するドキュメントの概要。
        src_type (str): ソースのタイプ（例: local, web, github）。
        discovery_path (str): discovery.jsonファイルへのパス。
    """
    try:
        with open(discovery_path, 'r+', encoding='utf-8') as f:
            try:
                data = json.load(f)
            except json.JSONDecodeError:
                print(f"Error: Could not decode JSON from {discovery_path}. Check file format.")
                return

            documents = data.get('documents', [])
            entry = {
                "path": path,
                "title": title,
                "summary": summary,
                "src_type": src_type
            }

            # 同じパスを持つ既存のエントリを検索
            found_index = -1
            for i, doc in enumerate(documents):
                if doc.get('path') == path:
                    found_index = i
                    break
            
            message = ""
            if found_index != -1:
                # 既存エントリを更新
                documents[found_index] = entry
                message = "Entry updated successfully."
            else:
                # 新しいエントリを追加
                documents.append(entry)
                message = "Entry added successfully."

            data['documents'] = documents
            
            # ファイルの先頭にシークしてから書き込む
            f.seek(0)
            json.dump(data, f, ensure_ascii=False, indent=2)
            f.truncate()

            print(json.dumps({
                "status": "success",
                "message": message,
                "entry": entry
            }, ensure_ascii=False, indent=2))

    except FileNotFoundError:
        print(f"Error: {discovery_path} not found at {os.path.abspath(discovery_path)}")


def main():
    """
    コマンドライン引数を解析し、entry_discovery関数を呼び出します。
    """
    parser = argparse.ArgumentParser(description="Add or update a document entry in discovery.json.")
    parser.add_argument("--path", required=True, help="Path of the cache directory to register.")
    parser.add_argument("--title", required=True, help="Title of the document to register.")
    parser.add_argument("--summary", required=True, help="Summary of the document to register.")
    parser.add_argument("--src-type", required=True, help="Source type (e.g., local, web, github).")
    
    args = parser.parse_args()

    # discovery.json はプロジェクトルートにあると想定
    discovery_file_path = os.path.join(os.path.dirname(__file__), '..', 'discovery.json')
    
    entry_discovery(args.path, args.title, args.summary, args.src_type, discovery_path=discovery_file_path)

if __name__ == "__main__":
    main()
```

## テスト方法

`entry_discovery.py`ツールが正しく機能することを確認するために、`test/test_entry_discovery.py` に定義された自動テストを実行します。

### 1. テストの実行
ターミナルで以下のコマンドを実行し、テストを開始します。

```bash
python -m unittest test/test_entry_discovery.py
```

### 2. テスト内容
このテストスイートは、`unittest`フレームワークと`mock`ライブラリを使用して、`discovery.json`への実際の書き込みを行わずに、以下のシナリオを検証します。

-   **新規エントリの追加:** 新しいドキュメント情報が `documents` リストに正しく追加されるか。
-   **既存エントリの更新:** 既存のドキュメント情報が正しく更新されるか（新しいエントリが重複して追加されないか）。
-   **エラーハンドリング:**
    -   `discovery.json` が見つからない場合にエラーが出力されるか。
    -   `discovery.json` が不正なJSON形式の場合にエラーが出力されるか。

すべてのテストが成功すれば、`entry_discovery.py` は正しく実装されていると判断できます。