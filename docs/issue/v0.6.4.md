# Issue v0.6.4

## 前提知識
- docs/Architecture/Architecture.md
- discovery.json (マスターツールカタログ)
- src/ragmaker/tools/install_kb.py

## 経緯
`ragmaker-install-kb` ツールはKBの移動・配置を行うが、移動後の `catalog.json` に記載されるドキュメントパスの計算に不備がある。現在はKBのルートからの相対パスとして記録されているが、実際にはKBを利用する「プロジェクト全体のルート」からの相対パスでなければ、別ディレクトリから実行される `/ask` 等のツールがファイルを正しく解決できない。

## 現状の問題点
- カタログ内の `path` が `catalog.json` ファイルからの相対パス（例: `cache/xxx.md`）になっており、プロジェクトルート起点ではない。
- ツールがインストール先のプロジェクトルートを把握する手段がないため、適切な相対パスを算出できない。
- マスターツールカタログ（`discovery.json`）の定義が現状の実装と乖離しており、必要な引数が定義されていない。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `ragmaker-install-kb` に `--project-root` 引数が追加され、正常に動作する。
- [ ] インストール後の `catalog.json` 内の `path` フィールドが、指定されたプロジェクトルートからの相対パスで記述されている。
- [ ] `discovery.json` の `install_kb` 定義が更新され、`project-root` パラメータが含まれている。
- [ ] プロジェクト全体の pytest を実行し、新規追加分を含む全てのテストがパスしている。

## 解決策の概要
`install_kb.py` にプロジェクトルートを指定する引数を追加する。ドキュメントの配置先絶対パスからプロジェクトルートを差し引いた相対パスを算出し、`catalog.json` を更新する。また、`discovery.json` を同期させる。

## 解決策の詳細
1. **`src/ragmaker/tools/install_kb.py` の修正**:
   - `argparse` に `--project-root` を追加。デフォルトは `.` (カレントディレクトリ) とする。
   - `install_knowledge_base` 関数を、プロジェクトルートを考慮したパス計算ロジックに修正する。
   - 計算式: `doc["path"] = (target_root / "cache" / rel_to_cache).relative_to(project_root).as_posix()`
2. **`discovery.json` の更新**:
   - `install_kb` ツールの `parameters` に `project-root` (string) を追加する。
3. **エラーハンドリング**:
   - 指定されたプロジェクトルートが、インストール先（`target-kb-root`）の親ディレクトリでない場合に適切なエラー（ValueError）を出す。

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ] `test/test_install_kb.py` を更新し、`--project-root` を指定した際のカタログ内パスの妥当性を検証するテストケースを追加した。
- [ ] `pytest test/test_install_kb.py` を実行し、パスすることを確認した。
- [ ] 手動確認: `ragmaker-install-kb --source <SRC> --target-kb-root ./subdir/kb --project-root .` を実行し、カタログ内のパスが `subdir/kb/cache/...` となっていることを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [ ]