# Issue v0.7.3

## 前提知識
- docs/Architecture/Architecture.md
- docs/issue/v0.7.2.md

## 経緯
v0.7.2 において `ragmaker-install-kb` ツールの機能拡張を行ったが、商用ソフトウェアとしての堅牢性と UX の予測可能性に課題が残っている。特にソース数による挙動の不一致、原子性の欠如、および例外捕捉の不備（Gemini Code Assist 指摘）を解決し、ツールの信頼性を極限まで高める。

## 現状の問題点
- 入力ソースが単一か複数かによって出力先のディレクトリ構造が自動的に変化するため、利用者の予測を裏切り自動化を困難にする。
- カタログマージ時に既存メタデータを全コピーしているため、不要なフィールドや古いスキーマ情報が永続的に継承される。
- `safe_export` におけるファイル・ディレクトリ衝突時の削除操作において、シンボリックリンクによる境界外への破壊のリスクが考慮されていない。
- `merge_catalog_data` において `except Exception:` が使用されており、システムレベルの例外を予期せず抑制している（gca 指摘）。
- ターゲットディレクトリを直接編集しているため、処理途中の失敗時に不完全な状態で放置される。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `src/ragmaker/tools/install_kb.py` におけるソース数による自動分岐を廃止し、常にターゲット直下にインストールする挙動に統一されている。
- [x] `src/ragmaker/utils.py` の `merge_catalog_data` において、メタデータの継承を「ホワイトリスト方式」で行っている。
- [x] `merge_catalog_data` 内の `Path.resolve()` に対する例外捕捉を `except (OSError, RuntimeError):` に限定している。
- [x] `src/ragmaker/utils.py` の `safe_export` で削除を行う前に `is_symlink()` を確認し、安全性を確保している。
- [x] インストール処理を `tempfile.TemporaryDirectory` 内で完遂させ、最後にターゲットへアトミックに差し替えることで原子性を確保している。
- [x] `discovery.json` のツール定義が、最新の挙動に合わせて更新されている。
- [x] プロジェクト全体の pytest を実行し、新規追加分を含む全てのテストがパスしている。

## 解決策の概要
`install_kb.py` の挙動を一貫させ、一時ディレクトリを用いたアトミックな更新（原子性の確保）を導入する。また、カタログマージ時のメタデータ処理と例外捕捉を厳密化し、シンボリックリンク保護による安全性を向上させる。

## 解決策の詳細
- `src/ragmaker/tools/install_kb.py` の修正：
  - `len(source_roots) == 1` 時の `target_root` 書き換えロジックを削除し、常に指定されたターゲットパスを使用する。
  - 処理開始時に `tempfile.TemporaryDirectory` を作成し、そこを一時的な `work_root` として KB を構築する。
  - カタログの書き込みまで完了した後、既存の `target_root` があれば削除（またはリネーム退避）し、`work_root` の内容を `target_root` に移動する。
- `src/ragmaker/utils.py` の修正：
  - `merge_catalog_data` で `sources`, `generator` 等の許可されたフィールドのみをマージするように変更する。
  - `Path.resolve()` 周りの例外捕捉を gca の提案通り `OSError`, `RuntimeError` に限定する。
  - `safe_export` において、衝突解消のための `unlink` や `rmtree` 前に `os.path.islink()` をチェックし、リンクであれば処理を中断して安全性を確保する。
- `discovery.json` の修正：
  - `install_kb` の説明文から、ソース数による分岐に関する記述を削除し、常にターゲットにインストール（またはマージ）する旨を記載する。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/install_kb.py`
- `src/ragmaker/utils.py`

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `test/test_install_kb.py` を更新し、ソース数に関わらず一貫した構造が作られることを検証した。
- [x] インストール処理中に意図的に例外を発生させ、ターゲットディレクトリが汚染されない（原子性が守られている）ことを検証した。
- [x] 巨大なメタデータを持つ既存カタログとのマージにおいて、ホワイトリスト以外の項目が削除されることを検証した。
- [x] `pytest test/test_install_kb.py` を実行し、全テストのパスを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] 全ての実装とテストを完了し、全テストパスを確認済み。
