# Issue v0.3.2: キャッシュディレクトリの上書き問題

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.toml
- .gemini/commands/ask.toml

## 現状の問題点
`/rag` コマンドでローカルディレクトリをソースとして取り込む際、キャッシュディレクトリの命名規則が `cache/<元のディレクトリ名>` となっているため、異なるパスだが同じディレクトリ名を持つソースを取り込むと、以前のキャッシュが上書きされてしまう。これにより、意図しないデータ損失が発生する可能性がある。

## 解決策の概要
キャッシュディレクトリの命名規則を、ソースの絶対パスを基にしたものに変更する。具体的には、`cache/<ドライブレター>/<ソースの絶対パスの残りの部分>` の形式とする。
例:
- `C:\users\amg\` の場合: `cache/C/users/amg/`
- `C:\foo\amg\` の場合: `cache/C/foo/amg/`


## 解決策の詳細
なお、rag.toml のキャッシュディレクトリに関する記述は、既にこの新しいロジックを反映するように更新済みである。
AIエージェント（jules）は、`/rag` コマンドで指定されたソースパスを基に、以下の手順でキャッシュディレクトリのパスを構築する。

1.  **パスの正規化:**
    *   ソースパスがWindowsパスの場合（例: `C:\users\amg\`）、ドライブレターを保持しつつ、すべてのバックスラッシュ（`\`）をスラッシュ（`/`）に変換する。
    *   ソースパスが非Windowsパスの場合（例: `/home/user/documents/`）、そのまま使用する。
    *   パスの末尾にスラッシュがない場合は追加する。
    *   これにより、`C/users/amg/` や `/home/user/documents/` のような正規化されたパスが得られる。
2.  **キャッシュディレクトリの構築:**
    *   正規化されたパスを `cache/` ディレクトリの直下に結合し、最終的なキャッシュディレクトリパスを生成する。
    *   例: `cache/C/users/amg/` または `cache/home/user/documents/`
3.  **`file_sync` ツールへの引数渡し:**
    *   `file_sync` ツールを呼び出す際に、`--dest-dir` 引数としてこの構築されたキャッシュディレクトリパスを渡す。

このアプローチにより、異なるOS環境やソースパスの形式に依存せず、一意で衝突しないキャッシュディレクトリが保証される。

## 参考とすべきスクリプト等
- `tools/file_sync.py`
- `.gemini/commands/rag.toml`
- `docs/Architecture/Architecture.md`

## テスト方法
1.  **テストケース1: 異なるパスだが同じディレクトリ名を持つソースの取り込み**
    *   `C:\users\amg\` のようなローカルディレクトリを `/rag` コマンドで取り込む。
    *   キャッシュディレクトリが `cache/C/users/amg/` のように正しく作成され、内容がコピーされていることを確認する。
    *   次に、`C:\foo\amg\` のような別のローカルディレクトリを `/rag` コマンドで取り込む。
    *   キャッシュディレクトリが `cache/C/foo/amg/` のように正しく作成され、以前の `cache/C/users/amg/` が上書きされていないことを確認する。
2.  **テストケース2: 同じパスの再取り込み**
    *   `C:\users\amg\` を `/rag` コマンドで取り込む。
    *   再度 `C:\users\amg\` を `/rag` コマンドで取り込む。
    *   キャッシュディレクトリが上書きされ、最新の内容が反映されていることを確認する（これは期待される動作）。
3.  **テストケース3: 非Windows環境でのテスト（もし可能であれば）**
    *   `/home/user/documents/` のようなローカルディレクトリを `/rag` コマンドで取り込む。
    *   キャッシュディレクトリが `cache/home/user/documents/` のように正しく作成され、内容がコピーされていることを確認する。