# Issue v0.6.1.5: github_fetch.py の堅牢性向上とテストの改善

## 前提知識
- docs/issue/v0.6.1.4.md
- src/ragmaker/tools/github_fetch.py
- test/test_github_fetch_error.py

## 用語の定義
- **GitCommandError**: GitPython において Git コマンドが失敗した際に送出される具体的な例外クラス。
- **カタログ汚染**: 出力ディレクトリ（temp_dir）に過去のファイルが残存しており、それらが意図せずカタログ（catalog.json）に登録されてしまう状態。

## 経緯
Issue v0.6.1.4 におけるエラーハンドリングの精密化に対し、実運用上の堅牢性とテストの正確性の観点からさらなる改善が必要であることが判明した。特に、エラーメッセージの具体化、出力ディレクトリの保護、およびコードベースの言語統一（英語）を行う。

## 現状の問題点
- **エラーメッセージの隠蔽**: `RuntimeError` のメッセージに根本原因（`final_exception`）の文字列表現が含まれていないため、Git 側の具体的な失敗理由がユーザーに伝わらない。
- **カタログ汚染のリスク**: `temp_dir` に以前のファイルが残っている場合、それらが今回の実行結果として誤ってカタログに登録される可能性がある。
- **言語の不一致**: 一部のコメントに日本語が使用されており、プロジェクトの英語統一方針に反している。
- **テストの不正確さ**: 異常系テストにおいて汎用的な `Exception` が使用されており、実際の `GitCommandError` の挙動を正確に模倣できていない。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `github_fetch.py` のクローン失敗時の `RuntimeError` メッセージに、根本原因（`final_exception`）の詳細が含まれている。
- [x] `github_fetch` 関数において、処理開始前またはコピー前に `temp_dir` の内容を安全にクリーンアップするか、あるいは今回の処理対象ファイルのみをカタログ化するロジックに変更されている。
- [x] `github_fetch.py` 内の日本語コメントがすべて英語に置換されている。
- [x] `test_github_fetch_error.py` において、`GitCommandError` を使用したより現実的なテストに更新され、未使用の `MagicMock` インポートが削除されている。
- [x] `pytest` を実行し、すべてのテストがパスしている。

## 解決策の概要
`github_fetch.py` のエラーメッセージとコメントを改善し、ディレクトリクリーンアップロジックを導入することで堅牢性を高める。また、テストコードを GitPython の仕様に合わせた形式に修正する。

## 解決策の詳細
### 1. github_fetch.py の修正
- **エラーメッセージ**: `raise RuntimeError(f"Full clone also failed after shallow clone attempt: {final_exception}") from final_exception` のように、`final_exception` の内容をメッセージに含める。
- **クリーンアップ**: `temp_dir` を使用する前に、`shutil.rmtree(temp_dir, ignore_errors=True)` 等でリセットを行うか、あるいは `temp_dir / path_in_repo` 配下のみを walk の対象にする。
- **コメント**: 日本語コメントを英語（例: `# Clarify that the full clone also failed after the shallow clone attempt.`）に修正する。

### 2. test_github_fetch_error.py の修正
- **GitCommandError の使用**: `GitCommandError("clone", 128, stderr="...")` を用いて、モックの `side_effect` を設定する。
- **リファクタリング**: 未使用の `from unittest.mock import MagicMock` を削除する。

## 参考とすべきスクリプト等
- docs/issue/v0.6.1.4.md
- PR #53 GCA レビューコメント

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `pytest test/test_github_fetch_error.py` を実行し、例外チェーンとメッセージに Git 側のエラーが含まれていることを確認した。
- [x] `temp_dir` にあらかじめダミーファイルを置いて実行し、それらが `catalog.json` に混入しないことを確認した。
- [x] プロジェクト全体の `pytest` がパスすることを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] v0.6.1.5 起草
- [x] エラーメッセージ具体化および日本語コメントの英語化完了
- [x] ディレクトリクリーンアップによるカタログ汚染対策完了
- [x] テストコードのリアリティ向上とリファクタリング完了
- [x] 最終確認完了
