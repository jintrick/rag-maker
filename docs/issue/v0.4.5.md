# Issue v0.4.5: `discovery.json` のアーキテクチャ統一と責務の明確化

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.toml
- .gemini/commands/ask.toml

## 現状の問題点
1.  **キャッシュ構造の非効率性とパスの問題**:
    -   `.gemini/commands/rag.md` の指示が古く、AIエージェントがソースURLを基に深い階層のキャッシュディレクトリを生成してしまい、構造が不必要に複雑化しています。

2.  **`discovery.json` の責務と配置の混乱**:
    -   現在のワークフローでは、ナレッジベースのルートとキャッシュディレクトリの両方に `discovery.json` が作成される可能性があり、アーキテクチャが混乱しています。
    -   「ナレッジベース全体のメタデータ」と「個々の文書カタログ」をどこに記録するべきかが不明確です。

## 解決策の概要
**`discovery.json` をナレッジベースごとに一つに統一します。**
この唯一の `discovery.json` は **`<KB_ROOT>/cache/discovery.json`** に配置され、ナレッジベース全体のメタデータと、個々の文書カタログの両方の情報を格納します。このアーキテクチャ変更に伴い、関連するツールと指示書を修正します。

## 解決策の詳細
1.  **`.gemini/commands/rag.md` の修正**:
    -   AIエージェントへの指示を修正し、キャッシュディレクトリのサブディレクトリを作成せず、常に `<KB_ROOT>/cache/` を直接の作業場所として使用するようにします。
    -   ワークフローの最後に `entry_discovery` を呼び出す際の指示を、新しい責務に合わせて修正します。

2.  **`create_knowledge_base.py` の修正 (責務の縮小)**:
    -   ナレッジベースのルートに `discovery.json` を生成するロジックを削除します。
    -   このツールは、ディレクトリ構造（`.gemini/commands`, `cache`）の作成のみに責務を限定します。

3.  **`entry_discovery.py` の修正 (責務の変更)**:
    -   このツールの責務を「キャッシュ内の `discovery.json` に、ナレッジベース全体のメタデータを追記・更新する」ことに変更します。
    -   `--kb-root` 引数を受け取り、`<KB_ROOT>/cache/discovery.json` を操作対象とします。
    -   `--title`, `--summary`, `--source-url`, `--src-type` といった引数を受け取り、それらを `header` というトップレベルのオブジェクトキーとして `discovery.json` に書き込みます。ファイルが存在しない場合は新規作成します。

## 参考とすべきスクリプト等
- `.gemini/commands/rag.md` (修正対象)
- `src/ragmaker/tools/create_knowledge_base.py` (修正対象)
- `src/ragmaker/tools/entry_discovery.py` (修正対象)
- `test/test_create_knowledge_base.py` (テスト内容の修正が必要)
- `test/test_entry_discovery.py` (テスト内容の修正が必要)

## テスト方法
1.  **`test_create_knowledge_base.py` の修正**:
    -   テストケースを修正し、`create_knowledge_base` ツール実行後に、ナレッジベースのルートに `discovery.json` が**生成されない**ことをアサートで確認するように変更します。
2.  **`test_entry_discovery.py` の修正**:
    -   テストを全面的に書き直し、`entry_discovery` が `<KB_ROOT>/cache/discovery.json` を正しく読み書きできることを確認します。
    -   ファイルが存在しない場合に新規作成されること、既存ファイルにトップレベルのメタデータが正しく追記・更新されることをテストします。
2.  **`/rag` コマンドの統合テスト**:
    -   `/rag https://example.com` のようなコマンドを実行します。
    -   ワークフロー完了後、`<KB_ROOT>/cache/` ディレクトリに `discovery.json` が**一つだけ**存在することを確認します。
    -   その `discovery.json` を開き、以下のような構造になっていることを確認します。
        ```json
        {
          "header": {
            "title": "...",
            "summary": "...",
            "src_type": "...",
            "source_url": "...",
            "fetched_at": "..."
          },
          "documents": [ ... ]
        }
        ```

## 実装状況
