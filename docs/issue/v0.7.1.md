# Issue v0.7.1

## 前提知識
- docs/Architecture/Architecture.md
- docs/issue/v0.7.0.md

## 経緯
v0.7.0 において `ragmaker-install-kb` ツールを複数ソース対応に拡張したが、事後レビューによりパス解決のバグおよび既存挙動の消失が確認された。本 issue ではこれらの不具合を修正し、ツールの完成度を高める。

## 現状の問題点
- カタログ（`catalog.json`）が KB ルートにある場合、ドキュメントの相対パス解決で `ValueError` が発生し、パスが更新されない。
- ターゲットディレクトリが既に存在する場合、その中にソース名のサブディレクトリを作成する旧来の挙動が失われている。
- インストール中にエラーが発生した場合、ターゲットが不完全な状態で残る。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `src/ragmaker/tools/install_kb.py` において、カタログの場所に関わらずドキュメントのパスが正しく `cache/` 相対に正規化されている。
- [x] 引数 `--source` が一つだけ指定され、かつターゲットディレクトリが既に存在する場合、その中にソース名のサブディレクトリを作成してインストールする。
- [x] 複数のソースが指定された場合は、現在の挙動通りターゲットディレクトリ直下にマージされる。
- [x] ファイルコピーやカタログ保存に失敗した場合、例外を捕捉し、どのソースのどの処理で失敗したかを出力して異常終了する。
- [x] プロジェクト全体の pytest を実行し、新規追加分を含む全てのテストがパスしている。

## 解決策の概要
`install_kb.py` のパス正規化ロジックを修正し、ソースカタログの場所を基準とした絶対パスからターゲットの `cache/` 相対パスを正しく計算する。また、インストール先ディレクトリの決定ロジックに単一ソース時の分岐を再導入する。

## 解決策の詳細
- `src/ragmaker/tools/install_kb.py` の `install_knowledge_base` 関数を修正する。
- パス解決ロジックの修正:
  - `doc_path` が `cache/` を含んでいるかどうかに依存せず、`abs_source_path`（ソース上の実体）を特定した後、それが `source_cache` の配下にあるかを確認する。
  - `abs_source_path.relative_to(source_cache)` が失敗する場合（カタログがルートにありドキュメントが `cache/` 外にある場合など）、適切に警告を出しつつ、ターゲットの `cache/` 構成に合わせたパスを構築する。
- インストール先決定ロジックの修正:
  - `len(source_roots) == 1` かつ `target_root.exists()` の場合、`target_root = target_root / source_roots[0].name` とする旧実装のロジックを復活させる。
- `discovery.json` の更新:
  - 今回の修正内容を反映し、ツールの `description` を「既存のKBをインストール先ディレクトリにコピー（単一ソースの場合はサブディレクトリ化、複数ソースの場合はマージ）し、パスを正規化してセットアップする」といった表現に更新する。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/install_kb.py` (v0.7.0 時点の実装)

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `test/test_install_kb.py` に、カタログがルートにあるソースKBを正しく処理できることを検証するテストケースを追加した。
- [x] 単一ソース指定時に既存ディレクトリ配下にサブディレクトリが作られることを検証するテストケースを追加した。
- [x] `pytest test/test_install_kb.py` を実行し、全テストのパスを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `install_kb`の修正とテスト追加完了
