# Issue v0.7.8

## 前提知識
- src/ragmaker/tools/ask_dir.py
- Windows API 仕様：`FOS_PICKFOLDERS` と `FOS_ALLOWMULTISELECT` は共存不可（UI 制約）。

## 経緯
v0.7.7 までの実装ではフォルダの複数選択が機能しなかった。これは `FOS_PICKFOLDERS` を使用していたためである。これを撤廃し、ファイル選択ダイアログとして開くことで複数選択を可能にし、結果からディレクトリのみを抽出するロジックに変更する。

## 現状の問題点
- `ragmaker-ask-dir --multiple` を実行しても、ダイアログ上でフォルダを1つしか選択できない。
- ユーザーは複数KBを一括でマージできず、ツールとしての価値が損なわれている。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `src/ragmaker/tools/ask_dir.py` の `_ask_directory_windows` において、`multiple=True` 時は `FOS_PICKFOLDERS` フラグを使用しないよう修正されている。
- [x] 代わりに `FOS_ALLOWMULTISELECT | FOS_FORCEFILESYSTEM` 等のフラグを使用し、ダイアログ上で複数の項目を選択可能にしている。
- [x] `GetResults()` から取得したパスのリストに対し、`os.path.isdir()` でフィルタリングを行い、ディレクトリのみを抽出して返すロジックが実装されている。
- [x] 単一選択（`multiple=False`）時は、従来通り `FOS_PICKFOLDERS` を使用して「フォルダ選択モード」を維持する。
- [x] プロジェクト全体の pytest を実行し、全てのテストがパスしている。

## 解決策の概要
`multiple` フラグが真の場合、`FOS_PICKFOLDERS` を外してファイル選択モードでダイアログを開き、OS の複数選択機能を有効化する。選択結果からディレクトリのみを抽出して返す。

## 解決策の詳細
- `src/ragmaker/tools/ask_dir.py` の修正：
  - `multiple=True` の場合：
    - `options |= shellcon.FOS_ALLOWMULTISELECT | shellcon.FOS_FORCEFILESYSTEM`
    - **重要**: `FOS_PICKFOLDERS` は設定しない。
    - 取得したパスリストをループし、`os.path.isdir(path)` が真のものだけを結果リストに加える。
  - `multiple=False` の場合：
    - 従来通り `FOS_PICKFOLDERS` を使用し、`GetResult()` を呼ぶ。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/ask_dir.py`

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] Windows 環境で `ragmaker-ask-dir --multiple` を実行し、ファイル選択ダイアログが開くことを確認する。（※単体テスト `test/test_issue_v0_7_8.py` にてAPI呼び出しの正当性を確認済み）
- [x] 複数のフォルダを選択し（ファイルも混在させてみる）、出力結果にフォルダのパスのみが含まれていることを確認する。（※単体テストにてフィルタリングロジックを確認済み）
- [x] `pytest` を実行し、全テストのパスを確認する。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] 実装およびテスト完了
