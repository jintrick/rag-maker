# Issue v0.4.18: `/rag` ワークフロー最終化に伴う関連ツールの実装・修正

## 前提知識
- docs/Architecture/Architecture.md
- .gemini/commands/rag.md

## 経緯
`.gemini/commands/rag.md` にて、`/rag` コマンドの最終的なワークフローが定義されました。この新しいワークフローは「①準備 → ②一時ディレクトリで全処理を完結 → ③完成品を最終配置」という、シンプルで一貫性のある流れを採用しています。

しかし、このワークフローを完全に実行するには、いくつかのツールが不足している、あるいは既存ツールの仕様がワークフローの要求と一致していないことが判明しました。

## 現状の問題点
1.  **準備ステップ用のツール欠如**: ワークフローのステップ0で指示されている、一時ディレクトリの初期化を行うための `init_cache` ツールが存在しません。
2.  **`entry_discovery` の引数の不一致**: ワークフローのステップ3では、`entry_discovery` ツールに `--discovery-path` で `discovery.json` のフルパスを渡すよう指示しています。しかし、現在の `entry_discovery.py` は `--kb-root` 引数しか受け付けず、パスを内部で組み立てる仕様になっているため、指示通りに動作しません。

## 解決策の概要
`.gemini/commands/rag.md` で定義されたワークフローを完全にサポートするため、不足しているツールを新規作成し、仕様が一致しない既存ツールを修正します。

## 解決策の詳細
1.  **`init_cache` ツールの新規作成**:
    -   **ファイル**: `src/ragmaker/tools/init_cache.py`
    -   **機能**: ワークフローの実行に必要な一時ディレクトリを初期化する。具体的には、既存の`.tmp/`ディレクトリを削除し、新しい`.tmp/cache/`ディレクトリを作成する。
    -   **引数**: なし
    -   **実装**: `shutil.rmtree('.tmp', ignore_errors=True)` と `os.makedirs('.tmp/cache', exist_ok=True)` を使用する。

2.  **`entry_discovery.py` の修正**:
    -   **ファイル**: `src/ragmaker/tools/entry_discovery.py`
    -   **引数の変更**: `--kb-root` 引数を廃止し、代わりに `--discovery-path` 引数を必須として受け取るように変更します。
    -   **ロジックの変更**: ツールは、`--discovery-path` で与えられたファイルパスを直接操作対象とします。

## 参考とすべきスクリプト等
- `.gemini/commands/rag.md` (最終的なワークフローの定義)
- `src/ragmaker/tools/init_cache.py` (新規作成対象)
- `src/ragmaker/tools/entry_discovery.py` (修正対象)

## テスト方法
1.  **`init_cache` の単体テスト作成**:
    -   `test/test_init_cache.py` を作成し、ツール実行後に`.tmp/cache`ディレクトリが正しく作成されることを確認します。
2.  **`entry_discovery` の単体テスト修正**:
    -   `test/test_entry_discovery.py` を修正し、`--kb-root` の代わりに `--discovery-path` を使ってツールを呼び出し、指定したファイルが正しく更新されることを検証します。
3.  **`/rag`コマンドの統合テスト**:
    -   `/rag`コマンドを実行し、AIエージェントが新しいワークフローに従って処理を進めることを確認します。
    -   特に、ステップ0で `init_cache` が、ステップ3で `entry_discovery` が `--discovery-path` 付きで呼び出されることをログで確認します。

## 実装状況

- julesによる実装完了
- pull完了
- ローカルリポジトリでのテストは未実施