# Issue v0.7.5

## 前提知識
- docs/Architecture/Architecture.md
- src/ragmaker/tools/ask_dir.py
- Windows COM API `IFileOpenDialog`

## 経緯
`ragmaker-install-kb` が複数ソースの統合に対応したが、その入力を担う `ask_dir` ツールが `tkinter` の制限によりフォルダの単一選択しかできない。複数の KB を効率的に扱うため、Windows 環境においてエクスプローラーネイティブな複数フォルダ選択 UI を導入し、UX の不整合を解消する。

## 現状の問題点
- `tkinter.filedialog.askdirectory` は一度に一つのフォルダしか選択できず、複数選択のオプションが存在しない。
- 複数のナレッジベースを一括でマージしたい場合、ユーザーはダイアログを何度も開き直す手間を強いられる。
- OS 標準の「複数フォルダ選択」という一般的な操作が提供されておらず、プロジェクトの利便性が損なわれている。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `pyproject.toml` の `dependencies` に `pywin32` が追加されている。
- [x] `src/ragmaker/tools/ask_dir.py` において、Windows 環境では `win32com.shell` を用いた `IFileOpenDialog` による実装が優先的に使用される。
- [x] 引数 `--multiple` が追加され、有効時にネイティブダイアログで複数フォルダの選択（Ctrl/Shift + クリック）が可能である。
- [x] 複数選択された結果が、`selected_directories` キーを持つ JSON 配列として標準出力される。
- [x] 非 Windows 環境、または `pywin32` が利用不可な環境では `tkinter` による単一選択（従来挙動）に安全にフォールバックする。
- [x] `discovery.json` の `ask_dir` 定義が、新しい引数と戻り値の仕様に合わせて更新されている。
- [x] プロジェクト全体の pytest を実行し、新規追加分を含む全てのテストがパスしている。

## 解決策の概要
`pywin32` を導入し、Windows の `IFileOpenDialog` API を直接制御する。`FOS_PICKFOLDERS` と `FOS_ALLOWMULTISELECT` フラグを有効化することで、ネイティブな複数フォルダ選択を実現する。

## 解決策の詳細
- **依存関係の追加**:
  - `pyproject.toml` に `pywin32` を追加する。
- **src/ragmaker/tools/ask_dir.py の修正**:
  - `sys.platform == 'win32'` の場合に `win32com.shell` から `CLSID_FileOpenDialog` を生成する。
  - `GetOptions` / `SetOptions` を使用し、`FOS_PICKFOLDERS (0x20)` および `FOS_ALLOWMULTISELECT (0x200)` を設定する。
  - `Show()` 実行後、`GetResults()` から `IShellItemArray` を取得し、ループで各アイテムの表示名（パス）を抽出する。
  - ユーザーがキャンセルした際（HRESULT `0x800704C7` 等）は、既存の `handle_user_cancellation` を呼び出す。
  - インポートエラーを適切にハンドリングし、`pywin32` がない場合は `tkinter` 実装へフォールバックさせる。
- **discovery.json の更新**:
  - `ask_dir` ツールの `parameters` に `multiple` (boolean) を追加し、説明文を更新する。

## 参考とすべきスクリプト等
- `src/ragmaker/tools/ask_dir.py` (現在の `tkinter` 実装)
- Python `pywin32` の `IFileOpenDialog` サンプルコード

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `test/test_ask_dir.py` を新規作成し、引数 `--multiple` のパースおよびフォールバックロジックを検証した。
- [x] Windows 環境で `ragmaker-ask-dir --multiple` を実行し、複数のフォルダを選択して正しい JSON 配列が得られることを目視確認した。
- [x] `pip install -e .` で依存関係が正しく認識されることを確認した。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] v0.7.5 実装完了
