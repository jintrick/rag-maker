# Issue v0.8.1: browser_fetch への対話モード（非ヘッドレス）の導入

## 前提知識
- `src/ragmaker/tools/browser_fetch.py`
- `discovery.json`

## 経緯
`browser_fetch` は現在ヘッドレスモード固定で動作している。しかし、Cloudflare のボット検知や CAPTCHA が導入されているサイト（例: `vtolvr.wiki.gg`）では、ヘッドレスブラウザからのアクセスが遮断される。これを回避し、必要に応じて人間が手動で認証や検証操作を行えるよう、ブラウザを可視化して実行を一時停止する「対話モード」を導入する。

## 現状の問題点
- ヘッドレスモードが検知され、コンテンツ取得に失敗するサイトが存在する。
- 認証や「人間であることの証明」が必要な際、自動処理が先行してしまい、空のページやエラーページを保存してしまう。
- `browser_fetch.py` は `asyncio` ベースであるため、単純な `input()` 呼び出しはイベントループをブロックし、ブラウザの描画やネットワーク処理を停止させる恐れがある。

## ゴール（完了の定義）
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `browser_fetch.py` に `--no-headless` 引数が追加され、有効時にブラウザが可視（headless=False）で起動する。
- [x] `browser_fetch.py` において、`--no-headless` 有効時に、ページ遷移直後に標準入力を待機する。
- [x] 標準入力の待機が `asyncio` のイベントループをブロックしないよう、`loop.run_in_executor` を用いて実装されている。
- [x] `discovery.json` の `browser_fetch` ツールのパラメータ定義に `no-headless` が追加されている。
- [x] `vtolvr.wiki.gg` に対して実行し、手動での CAPTCHA 解除後にコンテンツが正しく取得できることを確認した。

## 解決策の概要
`WebFetcher` クラスに非ヘッドレス起動オプションを追加し、`asyncio` コンテキスト内で安全にユーザー入力を待機する仕組みを構築する。また、ツールのメタデータを定義する `discovery.json` を更新して、外部からこのオプションを指定可能にする。

## 解決策の詳細

### 1. `src/ragmaker/tools/browser_fetch.py` の修正

#### 引数の追加
`main` 関数内の `argparse` 定義に以下を追加する。
- `parser.add_argument("--no-headless", action="store_true", help="Run browser in non-headless mode for manual intervention.")`

#### クラスプロパティの更新
`WebFetcher.__init__` に `self.no_headless = args.no_headless` を追加する。

#### ブラウザ起動オプションの変更
`WebFetcher._setup_browser` 内の `launch` 呼び出しを修正する。
- `self.browser = await self.playwright.chromium.launch(headless=not self.no_headless)`

#### 非ブロックの待機ロジックの実装
`WebFetcher._process_page` メソッド内の `page.goto` 呼び出し直後に、以下の処理を追加する。
- `self.no_headless` が `True` の場合、`sys.stderr` にガイドメッセージを表示し、`await asyncio.get_event_loop().run_in_executor(None, sys.stdin.readline)` を実行して Enter キーの入力を待機する。
- **注意**: `sys.stdout` は JSON 出力に使用されるため、プロンプトメッセージは必ず `sys.stderr` に出力すること。

### 2. `discovery.json` の更新

`browser_fetch` ツールの `parameters.properties` に `no-headless` を追加する。
- キー: `no-headless`
- 型: `boolean`
- 説明: `"ブラウザを可視状態で起動し、手動操作（CAPTCHA解決など）を待機する対話モードを有効にする。"`
- デフォルト値: `false`

## 参考とすべきスクリプト等
- `src/ragmaker/tools/browser_fetch.py`: 既存の `asyncio` 実装。

## テスト方法
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `python src/ragmaker/tools/browser_fetch.py --url https://vtolvr.wiki.gg/wiki/VTOL_VR_Wiki --base-url https://vtolvr.wiki.gg/wiki/ --output-dir .tmp/test_fetch --no-headless` を実行。
- [x] ブラウザウィンドウが表示されることを確認。
- [x] ターミナル（stderr）に待機メッセージが表示されることを確認。
- [x] 必要に応じて CAPTCHA を手動で解き、ターミナルで Enter を押下した後にスクレイピングが続行されることを確認。
- [x] 出力された Markdown ファイルに期待通りのコンテンツが含まれていることを確認。

## 実装状況
実装担当者は、完了報告前に以下の項目をすべて確認し、チェックを入れ、この文書を更新してcommitすること。
- [x] `browser_fetch.py` への引数追加と起動オプション変更の完了
- [x] `loop.run_in_executor` を用いた非ブロック入力待ちの実装の完了
- [x] `discovery.json` の更新完了
- [x] 動作検証の完了
