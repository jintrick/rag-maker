ソース（`{{args}}`）をナレッジソースとして取り込みます。
ワークフローに従い、以下のタスクを完了させてください。
ツールの使い方や引数の詳細は`discovery.json`を参照し、自律的に判断して実行してください。

## 注意事項
- あなたが利用するツール群は、すべて`discovery.json`にコマンドや引数が定義されています。これを読まないとフローを進めることができません。最初に、`discovery.json`を読み込んでください。
- あなたが利用するツール群は、`pip install -e .` によってシステムにコマンドとしてインストールされています。この仕組みは、`pyproject.toml` の `[project.scripts]` セクションで定義されています。
- パスの指定は相対パスで行ってください。絶対パスを指定する際には、スペースが含まれているケースを考慮して**ダブルクォーテーション**を使ってください。


---
## ワークフロー

### 0. 準備
1.  `init_cache` ツールを実行し、ワークフローの実行に必要な一時ディレクトリを初期化します。このツールは、既存の`.tmp/`ディレクトリを削除し、新しい`.tmp/cache/`ディレクトリを作成します。

### 1. データ取得と一時保存
**注意:** 最初に、`discovery.json`を読み込んでください。

**ソース `{{args}}` の種類を判断し、以下のいずれかのフローを実行してください。**

#### A) Webソースの場合 (`http` または `https` で始まるURL)
1.  **データ取得と変換:** `http_fetch` ツールを実行します。
    -   `--url` に `{{args}}` を指定します。
    -   `--base-url` には、収集範囲の基点となるURLを指定します（`{{args}}` から適切に判断してください）。
    -   `--output-dir` に `<プロジェクトルート>/.tmp/cache/` を指定します。
    -   このツールは、HTMLの取得、本文抽出、Markdown変換までをすべて行い、結果のJSONを**標準出力**に返します。
2.  **結果の評価と分岐:**
    -   `http_fetch` の実行結果（JSON）を確認します。
    -   **成功の場合:** `documents` が十分に取得できていれば、その標準出力をキャプチャし、`write_file` ツールを使って `<プロジェクトルート>/.tmp/cache/catalog.json` に保存します。その後、**ステップ2**へ進んでください。
    -   **AI Pilotingへの移行:** `documents` が空、`metadata.status` が `"fallback_recommended"`、あるいはWikiのような複雑なサイト構造で選択的な収集が必要な場合は、以下の **AI Pilotingワークフロー** を実行します。
        1. **ブラウザ初期化**: `browser_open` を実行します。
        2. **ナビゲーション**: `browser_navigate --url {{args}}` を実行します。
        3. **リンクの選別**: 得られた `links` から、主要な記事やドキュメントと思われるリンクを 5〜10 件選択します。
        4. **抽出ループ**: 選択した各リンクに対し、`browser_extract` を実行します。
           - `--output-dir` に `<プロジェクトルート>/.tmp/cache/` を指定します。
           - このツールは自動的に `<プロジェクトルート>/.tmp/cache/catalog.json` を更新します。
           - 必要に応じて、さらに深い階層へ `browser_navigate` して探索を続けても構いません。
        5. **終了**: `browser_close` を実行します。
3.  **次のステップへ:** **ステップ2. ドキュメントのエンリッチ** に進んでください。

#### B) GitHubソースの場合 (`github.com` を含むURL)
1.  **データ取得と変換:** `github_fetch` ツールを実行します。
    -   `--repo-url` に `{{args}}` を指定します。
    -   `--path-in-repo` には、リポジトリ内の収集対象パスを指定します（`{{args}}` から適切に判断してください）。
    -   `--output-dir` に `<プロジェクトルート>/.tmp/cache/` を指定します。
    -   このツールは、HTMLファイルをMarkdownに変換し、取得した全ファイルの一覧をJSONとして**標準出力**に返します。
2.  **一時ファイルへ保存:** `github_fetch` の標準出力をキャプチャし、`write_file` ツールを使って `<プロジェクトルート>/.tmp/cache/catalog.json` に保存します。
3.  **次のステップへ:** **ステップ2. ドキュメントのエンリッチ** に進んでください。
 
#### C) ローカルディレクトリの場合 (上記以外のパス)
1.  **データ取得と変換:** `file_sync` ツールを実行します。
    -   `--source-dir` に `{{args}}` を指定します。
    -   `--dest-dir` に `<プロジェクトルート>/.tmp/cache/` を指定します。
    -   このツールは、ファイルの変換と同期を行い、処理されたファイル一覧のJSONを**標準出力**に返します。
2.  **一時ファイルへ保存:** `file_sync` の標準出力をキャプチャし、`write_file` ツールを使って `<プロジェクトルート>/.tmp/cache/catalog.json` に保存します。
3.  **次のステップへ:** **ステップ2. ドキュメントのエンリッチ** に進んでください。

### 2. ドキュメントのエンリッチ
1. **エンリッチ情報の生成:**
    - まず、`<プロジェクトルート>/.tmp/cache/catalog.json`を**直接読み込み**、`documents`配列から各マークダウンファイルのパスを取得します。
    - 次に、それらのファイル（例: `.tmp/cache/doc1.md`）を一つずつ**直接読み込み**、それぞれの`title`と`summary`を**あなたの推論能力で生成**します。
    - **注意:** `.tmp/` ディレクトリ内のファイルは、ツールを使わずに直接読み書きできます。
2.  **エンリッチ情報の書き込み**
    -   結果を、以下の形式を持つオブジェクトの**配列**としてメモリ上に構築します。AIの仕事は、この配列を生成することだけです。
        ```json
        [
          {"path": "path/to/doc1.md", "title": "...", "summary": "..."},
          {"path": "path/to/doc2.md", "title": "...", "summary": "..."}
        ]
        ```
3.  **一括更新の実行:**
    -   `enrich_discovery` ツールを呼び出します。
    -   `--discovery-path` 引数に、更新対象である `<プロジェクトルート>/.tmp/cache/catalog.json` のパスを指定します。
    -   `--updates` 引数に、ステップ2で生成したJSON配列を**文字列として**渡します。
    -   このツールが、`<プロジェクトルート>.tmp/catalog.json` への安全かつ効率的な書き込みを実行します。

### 3. ナレッジベース全体のメタデータ登録
1.  **ナレッジベース全体のメタデータ生成:**
    -   エンリッチ済みの `<プロジェクトルート>/.tmp/cache/catalog.json` の内容を**直接読み込み**ます。
    -   ナレッジベース全体を表す**単一の** `title` と `summary` をあなたの推論能力で生成します。
2.  **メタデータの書き込み:**
    -   `entry_discovery` ツールを呼び出します。
    -   `--discovery-path` に `<プロジェクトルート>/.tmp/cache/catalog.json` を指定します。
    -   `--title` と `--summary` には今あなたが生成したものを、`--source-url` と `--src-type` にはワークフローの初期段階で与えられた情報を指定してください。


### 4. ナレッジベースの最終配置
1. 「ナレッジベースの作成が完了しました。保存場所を選択して下さいと告げ、`ask_dir` ツールを実行し、配置場所のパスを得ます（`kb_root`）。
2. `move_file` ツールを呼び出します。
    -   `--source` に `<プロジェクトルート>/.tmp/cache/` を指定します。
    -   `--destination` に最終的な配置場所である `{{kb_root}}/cache/` を指定します。

### 5. 完了報告
**注意:** 最初に、`discovery.json`を読み込んでください。
1.  **ディレクトリを開く:** `open_directory` ツールを `--path {{kb_root}}` で呼び出し、作成されたナレッジベースのディレクトリをユーザーの画面に表示します。
2.  **ユーザーへのメッセージ:** ツール実行後、以下のメッセージをユーザーに伝えてください。
    > ナレッジベースが作成されました。表示されたウィンドウ内でターミナルを開き、`/ask` コマンドで質問を開始してください。